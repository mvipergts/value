<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car Value, History & Maintenance Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root[data-theme="light"]{ --bg:#f7fafc; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569; --primary:#2563eb; --btn-text:#fff; --border:#d6e0ee; --accent:#e2e8f0; }
    :root[data-theme="dark"]{ --bg:#0c111c; --surface:#111827; --card:#111827; --text:#e9edf5; --muted:#b8c2d6; --primary:#2563eb; --btn-text:#fff; --border:#223047; --accent:#1e293b; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; max-width:1100px; margin:0 auto; padding:28px; 
      background: linear-gradient(180deg, var(--accent) 0%, var(--bg) 18%); 
      color:var(--text); font-size:16px; line-height:1.5; }
    input,button,textarea{ padding:12px 14px; margin:6px 0; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:12px; border:1px solid var(--primary); background:var(--primary); color:var(--btn-text); font-weight:800; letter-spacing:.2px; box-shadow:0 6px 18px rgba(37,99,235,.28); cursor:pointer; }
    .btn.secondary{ background:var(--surface); color:var(--primary); border-color:var(--primary); }
    .btn.full{ width:100%; justify-content:center; }
    .card{ border:1px solid var(--border); background:linear-gradient(180deg,var(--card),var(--surface)); padding:18px; border-radius:16px; margin:16px 0; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px; }
    .stat{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--accent); font-size:15px; }
    .stat:last-child{ border-bottom:0; }
    .muted{ color:var(--muted); font-size:12px; }
    pre{ background:#0a0f1a10; padding:12px; border-radius:12px; border:1px dashed var(--accent); white-space:pre-wrap }
    .card-value{ border-color: rgba(16,185,129,.35); background: linear-gradient(180deg, rgba(16,185,129,.08), var(--card)); box-shadow: 0 10px 24px rgba(16,185,129,.12); }
    .card-history{ border-color: rgba(245,158,11,.35); background: linear-gradient(180deg, rgba(245,158,11,.10), var(--card)); box-shadow: 0 10px 24px rgba(245,158,11,.14); }
    .card-maint{ border-color: rgba(99,102,241,.35); background: linear-gradient(180deg, rgba(99,102,241,.10), var(--card)); box-shadow: 0 10px 24px rgba(99,102,241,.16); }
    table thead th{ background: rgba(2,6,23,.03); padding:8px; }
    table tbody tr:nth-child(odd){ background: rgba(2,6,23,.02); }
    table td{ padding:8px; }
    #decodedBanner .card{ background: linear-gradient(180deg, rgba(37,99,235,.06), var(--surface)); border-color: rgba(37,99,235,.35); }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .badge.blue{ background:rgba(37,99,235,.12); color:#1e3a8a; border:1px solid rgba(37,99,235,.24); }
    .badge.amber{ background:rgba(245,158,11,.14); color:#7c2d12; border:1px solid rgba(245,158,11,.28); }
    .badge.green{ background:rgba(16,185,129,.14); color:#064e3b; border:1px solid rgba(16,185,129,.28); }
  </style>
</head>
<body data-theme="light">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
    <h1 style="margin:0">Car Value, History & Maintenance Tool</h1>
    <button id="themeBtn" class="btn secondary" onclick="toggleTheme()">Dark mode</button>
  </div>

  <div class="card">
    <label>VIN</label>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <input id="vin" placeholder="e.g., 1G1ZE5ST0GF253821" style="flex:2">
      <input id="mileage" type="number" min="0" step="1" placeholder="Current mileage" style="flex:1">
      <button class="btn" onclick="lookup()">Lookup</button>
    </div>
    <div id="decodedBanner" class="muted" style="margin-top:6px"></div>
    <div id="results" class="grid"></div>
  </div>

  <div class="card">
    <div class="muted" style="text-transform:uppercase; letter-spacing:.12em">Carfax</div>
    <h3 style="margin-top:6px">Upload Carfax PDF</h3>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <input type="file" id="carfax" accept="application/pdf,image/*">
      <button class="btn" onclick="uploadCarfax()">Upload</button>
      <button class="btn secondary" onclick="ocrLocal()">OCR scanned PDF</button>
      <div id="carfaxSpin" class="muted" style="display:none">Uploadingâ€¦</div>
    </div>
    <div id="carfaxUrl" class="muted"></div>
    <div id="carfaxSummaryBox"></div>
    <details style="margin-top:12px"><summary class="muted">Paste Carfax text (if your PDF is scanned)</summary>
      <textarea id="carfaxPaste" rows="6" style="width:100%" placeholder="Paste Carfax text here..."></textarea>
      <div><button class="btn secondary" onclick="summarizeCarfaxText()">Summarize Text</button></div>
    </details>
  </div>

  <div class="card" style="border-left:4px solid #10B981">
    <div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Reconditioning</div>
    <h3 style="margin-top:6px">Add Additional Costs</h3>
    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
      <button class="btn secondary" onclick="quickAdd('Tires (set)', 800)">+ Tires</button>
      <button class="btn secondary" onclick="quickAdd('Windshield', 300)">+ Windshield</button>
      <button class="btn secondary" onclick="quickAdd('Detail', 150)">+ Detail</button>
      <button class="btn secondary" onclick="quickAdd('Inspection', 120)">+ Inspection</button>
      <button class="btn secondary" onclick="quickAdd('Wheel alignment', 110)">+ Alignment</button>
      <button class="btn secondary" onclick="quickAdd('Brakes (pads/rotors est.)', 450)">+ Brakes</button>
      <button class="btn secondary" onclick="quickAdd('Battery', 180)">+ Battery</button>
    </div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <input id="costLabel" placeholder="Custom item (e.g., Headlight)">
      <input id="costAmount" type="number" min="0" step="1" placeholder="Amount">
      <button class="btn" onclick="addCost()">Add</button>
    </div>
    <table style="width:100%; margin-top:10px; border-collapse:collapse">
      <thead><tr><th style="text-align:left">Item</th><th style="text-align:right">Cost ($)</th><th></th></tr></thead>
      <tbody id="costRows"><tr><td colspan="3" class="muted">No additional costs added.</td></tr></tbody>
      <tfoot>
        <tr><td style="text-align:right; font-weight:bold">Reconditioning total:</td><td style="text-align:right; font-weight:bold" id="reconTotal">$0</td><td></td></tr>
      </tfoot>
    </table>
  </div>

  <div class="card card-maint" style="border-left:4px solid #6366F1">
    <div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-bottom:8px">
      <button class="btn" onclick="fetchCommonIssues()">Get Common Issues</button>
      <button class="btn secondary" onclick="fetchTSBs()">Get TSBs</button>
    </div>
    <div id="commonIssuesCallout" style="display:none; border-left:4px solid #F59E0B; background:rgba(245,158,11,.07); padding:10px; border-radius:10px; margin-bottom:8px">
      <strong>Heads up:</strong> <span id="commonNote"></span>
    </div>
    <div id="tsbBox" style="display:none; margin-top:8px; border-left:4px solid #6366F1; background:rgba(99,102,241,.08); padding:10px; border-radius:10px">
      <div class="muted" style="text-transform:uppercase; letter-spacing:.12em">Technical Service Bulletins</div>
      <div id="tsbCount" class="muted"></div>
      <ul id="tsbList" style="margin-top:6px"></ul>
    </div>
  </div>

  <div class="card" style="border-left:4px solid #0EA5E9">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <div class="muted" style="text-transform:uppercase; letter-spacing:.12em">Evidence</div>
        <h3 style="margin-top:6px">NHTSA + TSB Risk Overview</h3>
      </div>
      <div style="display:flex; gap:8px">
        <button class="btn" onclick="fetchEvidence()">Get Evidence</button>
        <button class="btn secondary" onclick="applyEvidenceToRecon()">Apply Top Risks to Recon</button>
      </div>
    </div>
    <div style="margin-top:8px">
      <span class="badge blue" id="badgeRecalls" style="display:none"></span>
      <span class="badge amber" id="badgeComplaints" style="display:none"></span>
      <span class="badge green" id="badgeTSB" style="display:none"></span>
    </div>
    <ul id="riskList" style="margin-top:8px"></ul>
  </div>

  <div class="card" style="border-left: 4px solid #2563EB">
    <h3>Reports</h3>
    <p class="muted">Create a clean, customer-ready PDF with values, evidence, and maintenance deduction breakdown.</p>
    <div style="display:flex; gap:12px; flex-wrap:wrap">
      <button class="btn" onclick="printCustomerPDF()">Print Customer PDF</button>
    </div>
  </div>

  <script>
    let valuation=null, history=null, maintenance=null, carfaxUrl=null, carfaxSummary=null, carfaxText='';
    let adjustedWholesale=null, gapItems=[];
    let costItems = [];
    let _evidence = null;

    function toggleTheme(){ const root=document.body; const cur=root.getAttribute('data-theme')||'light'; const next=cur==='light'?'dark':'light'; root.setAttribute('data-theme',next); document.getElementById('themeBtn').textContent = next==='light'?'Dark mode':'Light mode'; }
    const money = n => '$'+Number(n||0).toLocaleString();
    function vehicleBanner(d){ const y=d?.year||'â€”', make=d?.make||'â€”', model=d?.model||'â€”', trim=d?.trim||''; const miles=document.getElementById('mileage').value; const label=[y,make,model,trim].filter(Boolean).join(' '); return `<div class="card" style="padding:14px; border:2px solid var(--accent)"><strong style="font-size:18px">${label}</strong>${d?.bodyClass?` Â· ${d.bodyClass}`:''}${miles?` Â· ${Number(miles).toLocaleString()} mi`:''}</div>`; }

    function gapBreakdown(){
      if (!Array.isArray(gapItems) || !gapItems.length) return '';
      const rows = gapItems.map(it => `<tr><td>${it.label}</td><td style="text-align:right">${money(it.amount)}</td><td class="muted">${Array.isArray(it.rationale)?it.rationale.join(' â€¢ '):(it.rationale||'')}</td></tr>`).join('');
      const total = gapItems.reduce((s,it)=>s+Number(it.amount||0),0);
      return `<div class="card" style="margin-top:10px"><div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Maintenance Deductions</div><h3 style="margin-top:6px">Breakdown</h3><table style="width:100%; border-collapse:collapse; margin-top:6px"><thead><tr><th style="text-align:left">Item</th><th style="text-align:right">Amount</th><th style="text-align:left">Why</th></tr></thead><tbody>${rows}</tbody><tfoot><tr><td style="text-align:right; font-weight:700">Total</td><td style="text-align:right; font-weight:700">${money(total)}</td><td></td></tr></tfoot></table></div>`;
    }

    function valueBox(v){
      const w = (v && v.wholesale!==undefined) ? money(v.wholesale) : 'â€”';
      const r = (v && v.retail!==undefined) ? money(v.retail) : 'â€”';
      const adjRow = (adjustedWholesale!=null) ? `<div class="stat"><span><strong>Maintenance deduction</strong></span><span>-${money(gapItems.reduce((s,it)=>s+Number(it.amount||0),0))}</span></div><div class="stat"><span><strong>Wholesale (after gaps)</strong></span><span>${money(adjustedWholesale)}</span></div>` : '';
      const reconRows = (adjustedWholesale!=null) ? (()=>{ 
          const totalRecon = (costItems||[]).reduce((s,it)=>s+Number(it.amount||0),0);
          const target = Math.max(0, Number(adjustedWholesale||0) - totalRecon);
          return `<div class='stat'><span><strong>Reconditioning total</strong></span><span>${money(totalRecon)}</span></div>
                  <div class='stat'><span><strong>Target max buy</strong></span><span>${money(target)}</span></div>`;
        })() : '';
      return `<div><h4 style="font-size:18px">Value</h4><div class="card card-value" style="padding:12px"><div class="stat"><span><strong>Wholesale</strong></span><span>${w}</span></div><div class="stat"><span><strong>Retail</strong></span><span>${r}</span></div>${adjRow}${reconRows}</div>${adjustedWholesale!=null ? gapBreakdown() : ''}<div><button class="btn full" onclick="applyMaintenanceDeduction()">Apply Maintenance Deduction (Carfax)</button></div><details class="muted" style="margin-top:8px"><summary>Raw valuation data</summary><pre>${JSON.stringify(v, null, 2)}</pre></details></div>`;
    }

    function historyBox(h){ const acc=h?.accidents??'â€”', owners=h?.owners??'â€”', svc=h?.serviceRecords??'â€”'; return `<div><h4 style="font-size:18px">History</h4><div class="card card-history" style="padding:12px"><div class="stat"><span><strong>Accidents</strong></span><span>${acc}</span></div><div class="stat"><span><strong>Owners</strong></span><span>${owners}</span></div><div class="stat"><span><strong>Service Records</strong></span><span>${svc}</span></div></div></div>`; }

    function maintenanceBox(m){ const up=(m&&Array.isArray(m.upcoming))?m.upcoming.map(x=>`<li>${x}</li>`).join(''):'<li>â€”</li>'; const intervals=(m&&m.intervals)?Object.entries(m.intervals).map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join(''):''; return `<div><h4 style="font-size:18px">Maintenance</h4><div class="card card-maint" style="padding:12px"><div style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-bottom:8px"><button class="btn" onclick="fetchCommonIssues()">Get Common Issues</button><button class="btn secondary" onclick="fetchTSBs()">Get TSBs</button></div><div id="commonIssuesCallout" style="display:none; border-left:4px solid #F59E0B; background:rgba(245,158,11,.07); padding:10px; border-radius:10px; margin-bottom:8px"><strong>Heads up:</strong> <span id="commonNote"></span></div><div id="tsbBox" style="display:none; margin-top:8px; border-left:4px solid #6366F1; background:rgba(99,102,241,.08); padding:10px; border-radius:10px"><div class="muted" style="text-transform:uppercase; letter-spacing:.12em">Technical Service Bulletins</div><div id="tsbCount" class="muted"></div><ul id="tsbList" style="margin-top:6px"></ul></div><div class="muted" style="margin-top:8px"><strong>Upcoming</strong><ul>${up}</ul><strong>Intervals</strong><ul>${intervals}</ul></div></div></div>`; }

    async function lookup(){
      const vin=document.getElementById('vin').value.trim(); if(!vin) return alert('Enter a VIN');
      try {
        const d = await fetch(`/api/vin/${encodeURIComponent(vin)}`).then(r=>r.json());
        if (d && d.ok) { window._decodedYear = Number(d.year||0); document.getElementById('decodedBanner').innerHTML = vehicleBanner(d); }
      } catch {}
      const miles = Number(document.getElementById('mileage').value||0);
      const year = window._decodedYear || 0;
      valuation = await fetch(`/api/value/${vin}?mileage=${encodeURIComponent(miles)}&year=${encodeURIComponent(year)}`).then(r=>r.json());
      history = await fetch(`/api/history/${vin}`).then(r=>r.json());
      maintenance = await fetch(`/api/maintenance/${vin}`).then(r=>r.json());
      adjustedWholesale=null; gapItems=[];
      document.getElementById('results').innerHTML = valueBox(valuation) + historyBox(history) + maintenanceBox(maintenance);
    }

    async function uploadCarfax(){
      const file=document.getElementById('carfax').files[0]; if(!file) return alert('Choose a PDF first');
      const fd=new FormData(); fd.append('file', file); document.getElementById('carfaxSpin').style.display='inline';
      const res=await fetch('/api/carfax/upload',{method:'POST',body:fd}).then(r=>r.json()).catch(()=>null);
      document.getElementById('carfaxSpin').style.display='none';
      if(!res){ alert('Upload failed'); return; }
      if(res.url){ carfaxUrl=res.url; document.getElementById('carfaxUrl').innerHTML=`Uploaded: <a href="${res.url}" target="_blank">${res.url}</a>`; }
      carfaxSummary=res.summary; carfaxText=res.text||'';
      if(carfaxSummary && !carfaxSummary.note){ document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
      else { document.getElementById('carfaxSummaryBox').innerHTML = `<div class="card"><strong>Carfax Summary</strong><div class="muted">No text extracted. Use <b>OCR scanned PDF</b> or paste the text below.</div></div>`; }
    }

    function carfaxBox(s){
      const entries = Object.entries(s||{}).filter(([k,v]) => k!=='note' && v && ((Array.isArray(v)&&v.length) || (!Array.isArray(v))));
      if (!entries.length) return '<div class="card"><em>No Carfax summary extracted.</em></div>';
      const html = entries.map(([k,v]) => `<div class="stat"><span><strong>${k}</strong></span><span>${Array.isArray(v)?v.join(', '):String(v)}</span></div>`).join('');
      return `<div class="card"><div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Carfax</div><h3>Summary</h3>${html}</div>`;
    }

    async function summarizeCarfaxText(){
      const raw = document.getElementById('carfaxPaste').value||'';
      if (!raw.trim()) return alert('Paste Carfax text first');
      const res = await fetch('/api/carfax/summarize-text', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: raw }) }).then(r=>r.json());
      if (res.ok) { carfaxSummary = res.summary; document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
    }

    async function ocrLocal(){
      const file=document.getElementById('carfax').files[0]; if(!file) return alert('Choose a PDF or image first');
      const isPdf = /pdf$/i.test(file.type) || /\.pdf$/i.test(file.name);
      document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">OCR in progressâ€¦</div>';
      let text = '';
      if (!isPdf) {
        const imgURL = URL.createObjectURL(file);
        const { data: { text: ocrText } } = await Tesseract.recognize(imgURL, 'eng');
        text = ocrText; URL.revokeObjectURL(imgURL);
      } else {
        const arrayBuf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
        const maxPages = Math.min(pdf.numPages, 5);
        for (let p = 1; p <= maxPages; p++) {
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
          const { data: { text: otext } } = await Tesseract.recognize(canvas, 'eng');
          text += '\\n\\n' + otext;
        }
      }
      if (!text.trim()) { document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">OCR returned no text.</div>'; return; }
      const res = await fetch('/api/carfax/summarize-text', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: text }) }).then(r=>r.json());
      if (res.ok) { carfaxSummary = res.summary; document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
      else { document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">Failed to summarize OCR text.</div>'; }
    }

    async function applyMaintenanceDeduction(){
      if (!valuation) return alert('Run a VIN lookup first.');
      const body = { baseWholesale: Number(valuation?.wholesale||0), carfaxSummary: carfaxSummary||{}, carfaxText: carfaxText||'', mileage: Number(document.getElementById('mileage').value||0), year: (window._decodedYear||0) || 0 };
      const res = await fetch('/api/value/adjusted', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
      if (!res.ok) return alert('Could not calculate maintenance deduction');
      adjustedWholesale = res.adjustedWholesale; gapItems = res.items||[];
      document.getElementById('results').innerHTML = valueBox(valuation) + historyBox(history) + maintenanceBox(maintenance);
    }

    function moneyFmt(n){ return '$'+Number(n||0).toLocaleString(); }
    function quickAdd(label, amount){ costItems.push({label, amount}); renderCosts(); }
    function addCost(){
      const label = (document.getElementById('costLabel').value||'').trim();
      const amount = Number(document.getElementById('costAmount').value||0);
      if(!label || !amount){ alert('Enter an item and amount'); return; }
      costItems.push({label, amount}); document.getElementById('costLabel').value=''; document.getElementById('costAmount').value='';
      renderCosts();
    }
    function removeCost(i){ costItems.splice(i,1); renderCosts(); }
    function renderCosts(){
      const rows = costItems.map((it,i)=>`<tr><td>${it.label}</td><td style="text-align:right">${moneyFmt(it.amount)}</td><td><button class="btn secondary" onclick="removeCost(${i})">Remove</button></td></tr>`).join('');
      document.getElementById('costRows').innerHTML = rows || '<tr><td colspan="3" class="muted">No additional costs added.</td></tr>';
      const total = costItems.reduce((s,it)=>s+Number(it.amount||0),0);
      document.getElementById('reconTotal').innerText = moneyFmt(total);
      if (window.valuation) document.getElementById('results').innerHTML = valueBox(valuation) + historyBox(history) + maintenanceBox(maintenance);
    }

    async function fetchCommonIssues(){
      const vin = document.getElementById('vin').value.trim();
      const vehicle = document.getElementById('decodedBanner').innerText.trim();
      const res = await fetch('/api/maintenance/common-issues', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ vin, vehicle }) }).then(r=>r.json());
      if (!res || !res.ok){ alert('Could not fetch common issues'); return; }
      const issues = res.issues || [];
      const note = res.note || '';
      if (note){ const callout = document.getElementById('commonIssuesCallout'); document.getElementById('commonNote').innerText = note; callout.style.display='block'; }
      const listHtml = issues.map(i => `<li><strong>${i.title}</strong>${i.details?(' â€” ' + i.details):''}</li>`).join('');
      const maintCard = document.querySelector('.card.card-maint');
      const ul = document.createElement('ul'); ul.innerHTML = listHtml;
      maintCard.appendChild(ul);
    }

    async function fetchTSBs(){
      const vin = document.getElementById('vin').value.trim();
      let vehicle = ''; try { vehicle = document.getElementById('decodedBanner').innerText.trim(); } catch {}
      const res = await fetch('/api/maintenance/tsb', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ vin, vehicle }) }).then(r=>r.json());
      if (!res || !res.ok){ alert('Could not fetch TSBs'); return; }
      const box = document.getElementById('tsbBox');
      box.style.display = 'block';
      document.getElementById('tsbCount').innerText = `${res.count||0} bulletin(s) found for ${res.year||''} ${res.make||''} ${res.model||''}`;
      const items = res.items || [];
      const list = items.map(i => `<li><strong>${i.title||'TSB'}</strong>${i.summary?(' â€” ' + i.summary):''}</li>`).join('');
      document.getElementById('tsbList').innerHTML = list || '<li class="muted">No bulletins returned.</li>';
    }

    async function fetchEvidence(){
      const vin = document.getElementById('vin').value.trim();
      let vehicle = ''; try { vehicle = document.getElementById('decodedBanner').innerText.trim(); } catch {}
      const res = await fetch('/api/evidence/score', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ vin, vehicle }) }).then(r=>r.json());
      if (!res || !res.ok) { alert('Could not fetch evidence'); return; }
      _evidence = res;
      const bR = document.getElementById('badgeRecalls'); bR.style.display='inline-block'; bR.innerText = `Recalls: ${res.counts?.recalls ?? 0}`;
      const bC = document.getElementById('badgeComplaints'); bC.style.display='inline-block'; bC.innerText = `Complaints: ${res.counts?.complaints ?? 0}`;
      const bT = document.getElementById('badgeTSB'); bT.style.display='inline-block'; bT.innerText = `TSBs: ${res.counts?.tsbs ?? 0}`;
      const risks = res.topRisks || [];
      document.getElementById('riskList').innerHTML = risks.map(r => `<li><strong>${r.label}</strong> â€” score ${r.score} <span class="muted">(${r.rationale})</span>${(Array.isArray(r.checks)&&r.checks.length)?('<ul>'+r.checks.map(c=>`<li>${c}</li>`).join('')+'</ul>'):''}</li>`).join('') || '<li class="muted">No notable risks found.</li>';
    }

    function applyEvidenceToRecon(){
      if (!_evidence) { alert('Run Get Evidence first'); return; }
      const recs = _evidence.recommendations || [];
      if (!Array.isArray(recs) || !recs.length){ alert('No recon suggestions from evidence'); return; }
      const labels = new Set(costItems.map(x=>x.label).concat((gapItems||[]).map(x=>x.label)));
      let skipped=0, added=0;
      recs.forEach(it => { if (!labels.has(it.label)) { costItems.push(it); labels.add(it.label); added++; } else { skipped++; } });
      renderCosts();
      if (skipped) console.log(`Skipped ${skipped} duplicate suggestion(s)`);
      alert('Top risk suggestions added to Recon.');
    }

    async function printCustomerPDF(){
      const vin = document.getElementById('vin').value.trim();
      if (!vin) return alert('Enter a VIN first');
      const miles = Number(document.getElementById('mileage').value||0);
      let vehicle = '';
      try { const b = document.getElementById('decodedBanner').innerText.trim(); if (b) vehicle = b.replace(/\\s+/g, ' '); } catch {}
      const body = {
        vin, vehicle, mileage: miles,
        valuation: valuation || {},
        adjustedWholesale: (typeof adjustedWholesale === 'number') ? adjustedWholesale : null,
        deduction: Array.isArray(gapItems)? gapItems.reduce((s,it)=>s+Number(it.amount||0),0) : 0,
        gapItems: gapItems || [],
        carfaxSummary: carfaxSummary || {},
        carfaxUrl: carfaxUrl || '',
        additionalCosts: costItems || [],
        evidence: _evidence || null
      };
      const res = await fetch('/api/report/customer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
      if (res && res.url) window.open(res.url, '_blank'); else alert('Could not generate PDF');
    }
  </script>
</body>
</html>
