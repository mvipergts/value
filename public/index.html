<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Car Value, History & Maintenance Tool</title>
  <style>
    .stepper{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .step{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;border:1px solid var(--border);cursor:pointer}
    .step.active{background:#1e293b;border-color:#3b82f6;color:#e6f0ff}
    .step.done{background:#0f172a;color:#a7f3d0;border-color:#334155}
    .step .num{width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#334155;color:#cfe0ff;font-size:12px}
    .progress{height:6px;background:#0e1628;border:1px solid var(--border);border-radius:8px;margin-top:8px;overflow:hidden}
    .progress>div{height:100%;width:0;background:#3b82f6}
    .wizard-nav{position:sticky;bottom:0;background:rgba(11,18,32,0.9);backdrop-filter:blur(6px);border-top:1px solid var(--border);padding:10px;display:flex;justify-content:space-between;z-index:20}
  </style>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --text:#e6ecff; --muted:#9fb0d9; --accent:#4da3ff; --border:#27324a; }
    *{ box-sizing:border-box; } body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.1) blur(6px); background:rgba(11,18,32,0.85); border-bottom:1px solid var(--border); }
    .wrap{ max-width:1120px; margin:0 auto; padding:14px 16px; }
    h1{ margin:4px 0 10px; font-size:22px; } h3{ margin:0 0 8px; } h4{ margin:0 0 8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input,select,textarea{ background:#0e1628; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:8px 10px; }
    .btn{ background:#16213a; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:8px 12px; cursor:pointer; }
    .btn.primary{ background:#2563eb; border-color:#1d4ed8; }
    .badge{ display:inline-block; border:1px solid var(--border); padding:6px 10px; border-radius:999px; margin-left:6px; color:#cfe0ff; }
    .grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:0 2px 0 rgba(0,0,0,.2); }
    .muted{ color:var(--muted); } .no-print{}
    .contrib-bar{ display:flex; height:8px; overflow:hidden; border:1px solid var(--border); border-radius:6px; }
    .contrib-seg{ height:100%; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    body.mode-customer .internal-only{ display:none !important; }
    @media print{ .no-print{ display:none !important; } body{ background:#fff; color:#000; } .card{ border-color:#bbb; box-shadow:none; } .muted{ color:#333; } }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js">
// Wizard control
let CURRENT_STEP = 1;
const TOTAL_STEPS = 5;
function isStepComplete(n){
  if(n===1){ return !!(window.vehicle && (vehicle.year||vehicle.make||vehicle.model)); }
  if(n===2){ const txt=(document.getElementById('carfaxText')||{value:''}).value.trim(); return !!txt || !!window._carfaxSkipped; }
  if(n===3){ return true; }
  if(n===4){ return true; }
  if(n===5){ return true; }
  return true;
}
function showStep(n){
  CURRENT_STEP = Math.max(1, Math.min(TOTAL_STEPS, n));
  for(let i=1;i<=TOTAL_STEPS;i++){
    const sec = document.getElementById('step-'+i);
    if(sec) sec.style.display = (i===CURRENT_STEP?'block':'none');
  }
  // Update stepper classes
  document.querySelectorAll('#stepper .step').forEach(el=>{
    const s = Number(el.getAttribute('data-step'));
    el.classList.toggle('active', s===CURRENT_STEP);
    el.classList.toggle('done', s<CURRENT_STEP && isStepComplete(s));
  });
  // Progress bar
  const prog = document.getElementById('progBar');
  if (prog) prog.style.width = ( (CURRENT_STEP-1)/(TOTAL_STEPS-1) * 100 ) + '%';
  // Nav label
  document.getElementById('curStep').textContent = String(CURRENT_STEP);
  document.getElementById('navPrev').disabled = CURRENT_STEP===1;
  const nextBtn = document.getElementById('navNext');
  nextBtn.textContent = CURRENT_STEP===TOTAL_STEPS ? 'Finish' : 'Next ▶';
  // Gate Next
  nextBtn.disabled = !isStepComplete(CURRENT_STEP);
  // Populate review
  if(CURRENT_STEP===5){ populateReview(); }
}
function nextStep(){
  if(!isStepComplete(CURRENT_STEP)){ alert('Complete this step first.'); return; }
  if(CURRENT_STEP<TOTAL_STEPS) showStep(CURRENT_STEP+1);
}
function prevStep(){ if(CURRENT_STEP>1) showStep(CURRENT_STEP-1); }
function gotoStep(n){ if(n<=CURRENT_STEP || isStepComplete(CURRENT_STEP)) showStep(n); }

document.addEventListener('DOMContentLoaded', ()=>{
  // stepper click
  document.querySelectorAll('#stepper .step').forEach(el=>{
    el.addEventListener('click', ()=>{ gotoStep(Number(el.getAttribute('data-step'))); });
  });
  document.getElementById('navPrev').addEventListener('click', prevStep);
  document.getElementById('navNext').addEventListener('click', nextStep);
  showStep(1);
});

// Hook into lookup to enable moving beyond step 1
const _origLookup = window.lookupVIN;
window.lookupVIN = async function(){ await _origLookup(); const nextBtn = document.getElementById('navNext'); if(nextBtn) nextBtn.disabled = !isStepComplete(1); };

// Step 2 helpers
function skipCarfax(){ window._carfaxSkipped = true; setStatus('Carfax skipped. You can add later.'); const nextBtn = document.getElementById('navNext'); if(nextBtn && CURRENT_STEP===2) nextBtn.disabled = !isStepComplete(2); }
async function submitCarfax(){ 
  const text = document.getElementById('carfaxText').value.trim();
  if(!text){ alert('Add Carfax text or click Skip'); return; }
  const res = await fetch('/api/carfax/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}).then(r=>r.json());
  if(!res.ok){ alert('Parse failed'); return; }
  document.getElementById('proofCarfax').textContent = JSON.stringify(res.summary,null,2);
  document.getElementById('proofCarfax2').textContent = JSON.stringify(res.summary,null,2);
  setStatus('Carfax parsed.'); const nextBtn = document.getElementById('navNext'); if(nextBtn && CURRENT_STEP===2) nextBtn.disabled = !isStepComplete(2);
}

// Populate review step
function populateReview(){
  const rv = document.getElementById('revVehicle');
  const vt = `${window.vehicle?.year||''} ${window.vehicle?.make||''} ${window.vehicle?.model||''}`.trim();
  rv.textContent = vt || '—';

  const riskTxt = (document.getElementById('riskCounts')||{textContent:''}).textContent;
  const risks = document.getElementById('riskList')?.innerText || '—';
  document.getElementById('revRisks').innerHTML = `<div class="muted">${riskTxt}</div><div style="margin-top:6px">${risks.replaceAll('\\n','<br>')}</div>`;

  const retail = document.getElementById('numRetail').textContent;
  const whole = Number((document.getElementById('numWholeBase')||{value:0}).value||0);
  const maint = document.getElementById('numMaint').textContent;
  const recon = document.getElementById('numRecon').textContent;
  const risk = document.getElementById('numRisk').textContent;
  const max = document.getElementById('sumMax').textContent;
  document.getElementById('revTotals').innerHTML = [
    `Retail base: <strong>${retail}</strong>`,
    `Wholesale base: <strong>$${whole.toLocaleString()}</strong>`,
    `Maintenance: <strong>${maint}</strong>`,
    `Recon: <strong>${recon}</strong>`,
    `Risk reserve: <strong>${risk}</strong>`,
    `Target Max Buy: <strong>${max}</strong>`
  ].map(x=>`<div>${x}</div>`).join('');
}

</script>
  <script>try{window.pdfjsLib = window['pdfjs-dist/build/pdf']; if(pdfjsLib && pdfjsLib.GlobalWorkerOptions){ pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js'; }}catch(e){console.warn('PDFjs init',e);}</script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body class="mode-customer">
<header>
  <div class="wrap">
    <h1>Car Value, History & Maintenance Tool</h1>
    <div class="row">
      <span class="badge">Vehicle: <span id="sVehicle">—</span></span>
      <span class="badge">Max Buy: <span id="sumMax">$0</span></span>
      <span class="badge" id="diagJs">JS: Ready</span>
      <span class="badge" id="diagSrv">Server: …</span>
      <span class="badge">PDF: 
        <select id="pdfMode" onchange="setPdfMode(this.value)">
          <option value="customer" selected>Customer</option>
          <option value="internal">Internal</option>
        </select>
      </span>
      <button class="btn no-print" onclick="openSettings()">Settings</button>
      <button class="btn no-print" onclick="printCustomer()">Print Customer</button>
      <button class="btn no-print" onclick="printInternal()">Print Internal</button>
    </div>
    <div class="stepper no-print" id="stepper">
      <div class="step" data-step="1"><span class="num">1</span> VIN & Mileage</div>
      <div class="step" data-step="2"><span class="num">2</span> Carfax</div>
      <div class="step" data-step="3"><span class="num">3</span> Maintenance & Risks</div>
      <div class="step" data-step="4"><span class="num">4</span> Offer & Comps</div>
      <div class="step" data-step="5"><span class="num">5</span> Review & Print</div>
    </div>
    <div class="progress no-print"><div id="progBar"></div></div>
  </div>
</header>

<main class="wrap" style="padding-top:10px">
  <div id="step-1">
  <div class="card">
    <h3>1) VIN & Mileage</h3>
    <form id="vinForm" onsubmit="event.preventDefault(); lookupVIN();" class="row">
      <input id="vin" placeholder="VIN" style="min-width:320px"/>
      <input id="miles" placeholder="Mileage" type="number" min="0" style="width:160px"/>
      <button id="btnLookup" class="btn primary" type="button" data-action="lookup" onclick="lookupVIN()">Lookup</button>
      <button id="btnDemo" class="btn" type="button">Try Demo VIN</button>
    </form>
    <div id="vehicleBanner" class="muted" style="margin-top:8px"></div>
    <div id="statusLine" class="muted" style="margin-top:6px"></div>
    <div id="lookupDebug" class="muted" style="margin-top:4px; font-size:12px"></div>
  </div>

  </div>
  </div>
  <div id="step-2">
  <div class="card" id="step2" style="margin-top:14px; display:none">
    <h3>2) Carfax</h3>
    <div class="row">
      <input id="carfaxFile" type="file" accept=".pdf,image/*">
      <button class="btn" onclick="extractCarfax()">Extract Text</button>
      <button class="btn" onclick="ocrCarfax()">Scan with OCR</button>
      <button class="btn primary" onclick="submitCarfax()">Use Text</button>
      <button class="btn" onclick="skipCarfax()">Skip for now</button>
      <span id="cfSelected" class="muted">No file selected.</span>
    </div>
    <textarea id="carfaxText" placeholder="Carfax text here (auto-filled from PDF/OCR or paste manually)" style="width:100%; min-height:140px; margin-top:8px"></textarea>
  </div>

  </div>
  </div>
  <div id="step-3">
  <div class="card" id="step3" style="margin-top:14px; display:none">
    <h3>3) Maintenance, Recon & Evidence</h3>
    <div class="grid">
      <div class="card">
        <h4>Maintenance Deductions</h4>
        <div id="maintList" class="muted">No items yet.</div>
        <div class="row" style="margin-top:8px">
          <input id="maintName" placeholder="Item (e.g., Oil change)">
          <input id="maintAmt" type="number" min="0" placeholder="Amount">
          <button class="btn" onclick="addMaint()">Add</button>
        </div>
      </div>
      <div class="card">
        <h4>Recon (Additional Costs)</h4>
        <div class="row" style="flex-wrap:wrap">
          <button class="btn" onclick="addRecon('Tires',800)">+ Tires</button>
          <button class="btn" onclick="addRecon('Windshield',350)">+ Windshield</button>
          <button class="btn" onclick="addRecon('Detail',200)">+ Detail</button>
          <button class="btn" onclick="addRecon('Inspection',100)">+ Inspection</button>
        </div>
        <div id="reconList" class="muted" style="margin-top:6px">No items.</div>
      </div>
      <div class="card">
        <h4>NHTSA + TSB Risk Overview</h4>
        <div id="riskCounts" class="muted">Recalls: 0 Complaints: 0 TSBs: 0</div>
        <div id="riskList" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
    <div class="card internal-only" style="margin-top:10px">
      <details><summary>Carfax summary (raw)</summary><pre id="proofCarfax" class="internal-only">—</pre></details>
      <details><summary>Evidence (raw)</summary><pre id="proofEvidence" class="internal-only">—</pre></details>
    </div>
  </div>

  </div>
  </div>
  <div id="step-4">
  <div class="card" id="step4" style="margin-top:14px; display:none">
    <h3>4) Offer + Market Comps</h3>
    <div class="grid">
      <div class="card">
        <h4>Numbers</h4>
        <div>Retail base: <strong id="numRetail">$10,000</strong></div>
        <div>Wholesale base: <input id="numWholeBase" type="number" min="0" value="8000" style="width:140px"></div>
        <div>Maintenance deduction: <strong id="numMaint">$0</strong></div>
        <div>Recon total: <strong id="numRecon">$0</strong></div>
        <div>Risk reserve: <strong id="numRisk">$0</strong></div>
        <div class="muted" style="margin-top:6px">Desired profit, doc fee, holding % from Settings.</div>
      </div>

      <div class="card" id="weightsCard">
        <h4>Weighted Retail</h4>
        <div class="muted">Blend sources and apply.</div>
        <div class="row"><label style="width:160px">eBay SOLD</label><input id="wSold" type="range" min="0" max="100" value="50"></div>
        <div class="row"><label style="width:160px">Cars.com</label><input id="wCars" type="range" min="0" max="100" value="20"></div>
        <div class="row"><label style="width:160px">KBB</label><input id="wKbb" type="range" min="0" max="100" value="15"></div>
        <div class="row"><label style="width:160px">Black Book</label><input id="wBb" type="range" min="0" max="100" value="10"></div>
        <div class="row"><label style="width:160px">Manual</label><input id="wMan" type="range" min="0" max="100" value="5"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="applyWeightedRetail()">Apply Weighted Retail</button>
          <div class="muted">Result: <strong id="weightedOut">$0</strong></div>
        </div>
        <div class="contrib-bar" style="margin-top:8px">
          <div id="contribSold" class="contrib-seg" style="background:#c7d2fe; width:0%"></div>
          <div id="contribCars" class="contrib-seg" style="background:#a7f3d0; width:0%"></div>
          <div id="contribKbb" class="contrib-seg" style="background:#fde68a; width:0%"></div>
          <div id="contribBb" class="contrib-seg" style="background:#fca5a5; width:0%"></div>
          <div id="contribMan" class="contrib-seg" style="background:#d1fae5; width:0%"></div>
        </div>
      </div>

      <div class="card" id="ebayCard">
        <h4>eBay Comps (Free)</h4>
        <div class="row">
          <input id="zip" placeholder="ZIP (optional)" style="width:140px">
          <select id="radius"><option value="100">100 mi</option><option value="250">250 mi</option><option value="500" selected>500 mi</option></select>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" onclick="fetchEbay('sold')">Fetch SOLD</button>
          <button class="btn" onclick="fetchEbay('active')">Fetch ACTIVE</button>
          <button class="btn" onclick="useSoldMedian()">Use SOLD Median as Retail</button>
        </div>
        <div id="ebayStats" class="muted" style="margin-top:6px">—</div>
        <details style="margin-top:6px"><summary>Sold list</summary><div id="soldList" class="muted">No results</div></details>
        <details style="margin-top:6px"><summary>Active list</summary><div id="activeList" class="muted">No results</div></details>
      </div>

      <div class="card">
        <h4>Proof</h4>
        <details><summary>Carfax summary (raw)</summary><pre id="proofCarfax2" class="internal-only">—</pre></details>
        <details><summary>Evidence (raw)</summary><pre id="proofEvidence2" class="internal-only">—</pre></details>
      </div>
    </div>
  </div>
</div>
  </div>
  <div id="step-5" style="display:none">
    <div class="card">
      <h3>5) Review & Print</h3>
      <div class="grid">
        <div class="card"><h4>Vehicle</h4><div id="revVehicle">—</div></div>
        <div class="card"><h4>Totals</h4><div id="revTotals">—</div></div>
        <div class="card"><h4>Risks</h4><div id="revRisks">—</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="printCustomer()">Print Customer</button>
        <button class="btn" onclick="printInternal()">Print Internal</button>
      </div>
    </div>
  </div>

  <div class="wizard-nav no-print">
    <button class="btn" id="navPrev">◀ Back</button>
    <div class="muted">Step <span id="curStep">1</span> of 5</div>
    <button class="btn primary" id="navNext">Next ▶</button>
  </div>
</main>

<!-- Settings Modal -->
<div id="settingsModal" class="no-print" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:1000">
  <div class="card" style="width:520px; max-width:90vw; background:#fff; color:#111">
    <h3>Settings</h3>
    <div class="muted" style="color:#333">Applies immediately to offer math.</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px">
      <label>Desired Profit ($)<br><input id="setProfit" type="number" min="0"></label>
      <label>Doc Fee ($)<br><input id="setDoc" type="number" min="0"></label>
      <label>Holding % (0–0.1)<br><input id="setHold" type="number" step="0.001" min="0" max="0.5"></label>
      <label>Risk per Recall ($)<br><input id="setRisk" type="number" min="0"></label>
    </div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn" onclick="closeSettings()">Cancel</button>
      <button class="btn primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
function fmt(n){ return '$'+(Number(n||0).toLocaleString()); }
function setBadge(id, txt){ const el=document.getElementById(id); if(el) el.textContent = txt; }

(async ()=>{ try{ const j=await fetch('/api/health').then(r=>r.json()); if(j&&j.ok) setBadge('diagSrv','Server: OK'); else setBadge('diagSrv','Server: DOWN'); }catch(e){ setBadge('diagSrv','Server: DOWN'); } })();

function setPdfMode(mode){
  document.body.classList.remove('mode-customer','mode-internal');
  document.body.classList.add(mode==='internal' ? 'mode-internal' : 'mode-customer');
  const sel = document.getElementById('pdfMode'); if(sel) sel.value = (mode==='internal'?'internal':'customer');
}
function printCustomer(){ setPdfMode('customer'); window.print(); }
function printInternal(){ setPdfMode('internal'); window.print(); }
setPdfMode('customer');

function setStatus(msg){ const el=document.getElementById('statusLine'); if(el) el.textContent = msg||''; }

window.lookupVIN = async function(){
  const btn = document.getElementById('btnLookup');
  const dbg = document.getElementById('lookupDebug');
  try{
    if(dbg){ dbg.textContent = 'Lookup clicked @ '+(new Date()).toLocaleTimeString(); }
    if(btn){ btn.disabled = true; btn.textContent = 'Looking up…'; }
    setStatus('Decoding VIN (VPIC)…');
    const vin = (document.getElementById('vin')||{value:''}).value.trim();
    const miles = Number((document.getElementById('miles')||{value:0}).value||0);
    if(!vin){ alert('Enter a VIN'); setStatus('Enter a VIN'); return; }

    let vehicle={};
    try{
      const r = await fetch('https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/'+encodeURIComponent(vin)+'?format=json');
      const j = await r.json();
      const row = j?.Results?.[0] || {};
      vehicle = { year: row.ModelYear||null, make: row.Make||null, model: row.Model||null, bodyClass: row.BodyClass||null };
      window.vehicle = vehicle;
      const t = `${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}${miles?(' • '+miles.toLocaleString()+' mi'):''}`.trim();
      const banner = document.getElementById('vehicleBanner');
      const chip = document.getElementById('sVehicle');
      if (chip) chip.textContent = t;
      if (banner){ banner.innerHTML = `<strong>${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}</strong>${vehicle.bodyClass?(' · '+vehicle.bodyClass):''}${miles?(' · '+miles.toLocaleString()+' mi'):''}`; }
      setStatus('Vehicle identified. Fetching evidence…');
    }catch(e){ setStatus('VPIC failed; trying server…'); }

    ['step2','step3','step4'].forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display='block'; });

    (async ()=>{
      try{
        const dec = await fetch('/api/evidence/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vin})}).then(r=>r.json());
        if(dec && dec.ok){
          window.vehicle = dec.vehicle || window.vehicle || {};
          if (typeof renderEvidence==='function') renderEvidence(dec);
          setStatus('Evidence loaded.');
          if(dbg) dbg.textContent += ' • evidence ok';
        }else{ setStatus('Evidence failed.'); if(dbg) dbg.textContent += ' • evidence fail'; }
      }catch(e){ setStatus('Evidence error.'); if(dbg) dbg.textContent += ' • evidence error'; }
    })();

    refreshOffer();
  }catch(e){ alert('Lookup failed: '+(e?.message||e)); setStatus('Lookup failed.'); }
  finally{ if(btn){ btn.disabled=false; btn.textContent = 'Lookup'; } }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const b = document.getElementById('btnLookup');
  if (b) b.addEventListener('click', (ev)=>{ ev.preventDefault(); window.lookupVIN(); });
  const demo = document.getElementById('btnDemo');
  if (demo) demo.addEventListener('click', (ev)=>{ ev.preventDefault(); document.getElementById('vin').value='1HGCR2F53FA129176'; document.getElementById('miles').value='203000'; window.lookupVIN(); });
  const vinI = document.getElementById('vin');
  if (vinI) vinI.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); window.lookupVIN(); } });
});

function renderEvidence(dec){
  const c = dec.counts || {recalls:0, complaints:0, tsbs:0};
  const risks = dec.topRisks||[];
  document.getElementById('riskCounts').textContent = `Recalls: ${c.recalls||0} Complaints: ${c.complaints||0} TSBs: ${c.tsbs||0}`;
  document.getElementById('riskList').innerHTML = risks.length? risks.map(r=>`<div>• <strong>${r.label}</strong> — ${r.rationale||''}</div>`).join('') : '<div class="muted">No specific risks highlighted.</div>';
  document.getElementById('proofEvidence').textContent = JSON.stringify(dec,null,2);
  document.getElementById('proofEvidence2').textContent = JSON.stringify(dec,null,2);
  refreshOffer();
}

document.getElementById('carfaxFile')?.addEventListener('change', (e)=>{
  const f = e.target.files?.[0]; window._cfFile = f || null;
  document.getElementById('cfSelected').textContent = f ? `Selected: ${f.name}` : 'No file selected.';
});
async function extractCarfax(){
  try{
    const f = window._cfFile; if(!f){ alert('Pick a PDF first'); return; }
    const buf = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: buf}).promise;
    let text = ''; const maxPages = Math.min(pdf.numPages, 12);
    for (let i=1;i<=maxPages;i++){ const page = await pdf.getPage(i); const tc = await page.getTextContent(); text += tc.items.map(it=>it.str).join(' ') + '\n'; }
    document.getElementById('carfaxText').value = text.trim(); setStatus('Carfax text extracted.'); 
  }catch(e){ alert('Extract failed; try OCR.'); }
}
async function ocrCarfax(){
  try{
    const f = window._cfFile; if(!f){ alert('Pick a PDF or image'); return; }
    let text = '';
    if (f.type.startsWith('image/')){
      const url = URL.createObjectURL(f); const { data:{ text: out } } = await Tesseract.recognize(url, 'eng'); URL.revokeObjectURL(url); text = out;
    } else {
      const buf = await f.arrayBuffer(); const pdf = await pdfjsLib.getDocument({data: buf}).promise;
      const max = Math.min(pdf.numPages, 3);
      for (let i=1;i<=max;i++){ const page = await pdf.getPage(i); const vp = page.getViewport({scale:1.6}); const cv = document.createElement('canvas'); const cx = cv.getContext('2d'); cv.width=vp.width; cv.height=vp.height; await page.render({canvasContext:cx, viewport:vp}).promise; const dataURL=cv.toDataURL('image/png'); const { data:{ text: out } } = await Tesseract.recognize(dataURL, 'eng'); text += out + '\n'; }
    }
    document.getElementById('carfaxText').value = text.trim(); setStatus('OCR complete.'); 
  }catch(e){ alert('OCR failed'); }
}
async function submitCarfax(){
  const text = document.getElementById('carfaxText').value.trim();
  if(!text){ alert('Add Carfax text first.'); return; }
  const res = await fetch('/api/carfax/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}).then(r=>r.json());
  if(!res.ok){ alert('Parse failed'); return; }
  document.getElementById('proofCarfax').textContent = JSON.stringify(res.summary,null,2);
  document.getElementById('proofCarfax2').textContent = JSON.stringify(res.summary,null,2);
  setStatus('Carfax parsed.'); refreshOffer();
}

let maintItems = []; let reconItems = []; window._retailBase = 10000;
function addMaint(){ const n=document.getElementById('maintName').value.trim(); const a=Number(document.getElementById('maintAmt').value||0); if(!n||!a) return; maintItems.push({name:n, amount:a}); renderMaint(); refreshOffer(); }
function addRecon(n,a){ reconItems.push({name:n, amount:a}); renderRecon(); refreshOffer(); }
function renderMaint(){ const el=document.getElementById('maintList'); if(!maintItems.length){ el.innerHTML='<div class="muted">No items yet.</div>'; return; } el.innerHTML = '<table style="width:100%">'+maintItems.map(i=>`<tr><td>${i.name}</td><td style="text-align:right">${fmt(i.amount)}</td></tr>`).join('')+'</table>'; }
function renderRecon(){ const el=document.getElementById('reconList'); if(!reconItems.length){ el.innerHTML='<div class="muted">No items.</div>'; return; } el.innerHTML = '<table style="width:100%">'+reconItems.map(i=>`<tr><td>${i.name}</td><td style="text-align:right">${fmt(i.amount)}</td></tr>`).join('')+'</table>'; }

async function refreshOffer(){
  const retailBase = (window._retailBase||10000);
  document.getElementById('numRetail').textContent = fmt(retailBase);
  const wholesaleBase = Number((document.getElementById('numWholeBase')||{value:0}).value||0);
  const maintDeduction = maintItems.reduce((s,i)=>s+(i.amount||0),0);
  const reconTotal = reconItems.reduce((s,i)=>s+(i.amount||0),0);
  const riskTxt = (document.getElementById('riskCounts')||{textContent:''}).textContent;
  const rx = /Recalls\s+(\d+)/.exec(riskTxt); const recalls = rx? Number(rx[1]) : 0;
  const riskReserve = recalls * 80;
  document.getElementById('numMaint').textContent = fmt(maintDeduction);
  document.getElementById('numRecon').textContent = fmt(reconTotal);
  document.getElementById('numRisk').textContent = fmt(riskReserve);
  const body = { retailBase, wholesaleBase, maintDeduction, reconTotal, riskReserve };
  const out = await fetch('/api/offer/calc',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json());
  const max = out?.numbers?.targetMaxBuy || 0;
  document.getElementById('sumMax').textContent = fmt(max);
}

function applyWeightedRetail(){
  const wSold=+document.getElementById('wSold').value||0, wCars=+document.getElementById('wCars').value||0, wKbb=+document.getElementById('wKbb').value||0, wBb=+document.getElementById('wBb').value||0, wMan=+document.getElementById('wMan').value||0;
  const vSold=+window._lastSoldMedian||0, vCars=+window._carsMedian||0;
  const vKbb=+((document.getElementById('kbbRetail')||{value:0}).value||0);
  const vBb =+((document.getElementById('bbRetail')||{value:0}).value||0);
  const vMan=0;
  const sources=[]; function push(id,w,v){ if(w>0 && v>0) sources.push({id,w,v}); }
  push('Sold',wSold,vSold); push('Cars',wCars,vCars); push('KBB',wKbb,vKbb); push('BB',wBb,vBb); push('Manual',wMan,vMan);
  if(!sources.length){ alert('Provide at least one source value.'); return; }
  const sumW = sources.reduce((s,x)=>s+x.w,0) || 1;
  const blended = Math.round(sources.reduce((s,x)=> s + (x.w/sumW)*x.v, 0));
  window._retailBase = blended; document.getElementById('weightedOut').textContent = fmt(blended);
  const map = Object.fromEntries(sources.map(s=>[s.id,(s.w/sumW)*100]));
  document.getElementById('contribSold').style.width = (map['Sold']||0)+'%';
  document.getElementById('contribCars').style.width = (map['Cars']||0)+'%';
  document.getElementById('contribKbb').style.width  = (map['KBB']||0)+'%';
  document.getElementById('contribBb').style.width   = (map['BB']||0)+'%';
  document.getElementById('contribMan').style.width  = (map['Manual']||0)+'%';
  refreshOffer();
}

async function fetchEbay(kind){
  const year = window.vehicle?.year||''; const make = window.vehicle?.make||''; const model = window.vehicle?.model||'';
  const zip = (document.getElementById('zip')||{value:''}).value.trim();
  const radius = (document.getElementById('radius')||{value:'500'}).value;
  const qs = new URLSearchParams({ year, make, model, zip, radius, type: kind }).toString();
  const res = await fetch('/api/ebay/comps?'+qs).then(r=>r.json());
  if(!res.ok){ document.getElementById('ebayStats').textContent = res.error||'No results'; return; }
  const s = res.stats||{};
  document.getElementById('ebayStats').textContent = `${kind.toUpperCase()} — n=${s.count||0} • median ${fmt(Math.round(s.median||0))} • avg ${fmt(Math.round(s.avg||0))} • range ${fmt(s.min||0)}–${fmt(s.max||0)}`;
  const items = (res.items||[]).slice(0,20).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0"><a href="${x.url}" target="_blank">${x.title}</a> — <strong>${fmt(x.price)}</strong> <span class="muted">${x.loc||''}</span></div>`).join('') || '<div class="muted">No results.</div>';
  if(kind==='sold'){ document.getElementById('soldList').innerHTML = items; window._lastSoldMedian = Math.round(s.median||0); }
  else { document.getElementById('activeList').innerHTML = items; }
}
function useSoldMedian(){ if(!window._lastSoldMedian){ alert('Fetch SOLD comps first.'); return; } window._retailBase = window._lastSoldMedian; refreshOffer(); }

function openSettings(){ const m=document.getElementById('settingsModal'); if(m){ m.style.display='flex'; loadSettingsIntoModal(); } }
function closeSettings(){ const m=document.getElementById('settingsModal'); if(m){ m.style.display='none'; } }
async function loadSettingsIntoModal(){
  try{ const j = await fetch('/api/settings').then(r=>r.json()); if(j.ok){ const s=j.settings||{}; setVal('setProfit', s.desiredProfit??2000); setVal('setDoc', s.docFee??200); setVal('setHold', s.holdingPercent??0.02); setVal('setRisk', s.riskReservePerRecall??80); } }catch(e){}
}
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v; }
async function saveSettings(){
  const body={ desiredProfit:+(document.getElementById('setProfit').value||0), docFee:+(document.getElementById('setDoc').value||0), holdingPercent:+(document.getElementById('setHold').value||0), riskReservePerRecall:+(document.getElementById('setRisk').value||0) };
  const j = await fetch('/api/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json());
  if(j.ok){ closeSettings(); refreshOffer(); } else alert('Save failed');
}
document.addEventListener('click', (ev)=>{ const m=document.getElementById('settingsModal'); if(m && ev.target===m) closeSettings(); });

window.addEventListener('error', (e)=>{ console.error('JS error', e.error||e.message); });
window.addEventListener('unhandledrejection', (e)=>{ console.error('Unhandled rejection', e.reason); alert('Error: '+(e.reason&&e.reason.message?e.reason.message:e.reason)); });
</script>
</body>
</html>
