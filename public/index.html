<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car Value, History & Maintenance Tool</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <style>
    :root[data-theme="light"]{ --bg:#f7fafc; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569; --primary:#2563eb; --btn-text:#fff; --border:#d6e0ee; --accent:#e2e8f0; }
    :root[data-theme="dark"]{ --bg:#0c111c; --surface:#111827; --card:#111827; --text:#e9edf5; --muted:#b8c2d6; --primary:#2563eb; --btn-text:#fff; --border:#223047; --accent:#1e293b; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; max-width:1100px; margin:0 auto; padding:28px; background:var(--bg); color:var(--text); font-size:16px; line-height:1.5; }
    input,button,textarea{ padding:12px 14px; margin:6px 0; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; }
    button{ background:var(--primary)!important; color:var(--btn-text)!important; font-weight:700; cursor:pointer; border:1px solid var(--border); }
    .card{ border:1px solid var(--border); background:linear-gradient(180deg,var(--card),var(--surface)); padding:18px; border-radius:16px; margin:16px 0; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:14px; }
    .stat{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--accent); font-size:15px; }
    .stat:last-child{ border-bottom:0; }
    .muted{ color:var(--muted); font-size:12px; }
    pre{ background:#0a0f1a10; padding:12px; border-radius:12px; border:1px dashed var(--accent); white-space:pre-wrap }
  </style>
</head>
<body data-theme="light">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px">
    <h1 style="margin:0">Car Value, History & Maintenance Tool</h1>
    <button id="themeBtn" onclick="toggleTheme()" style="background:#334155">Dark mode</button>
  </div>

  <div class="card">
    <label>VIN</label>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <input id="vin" placeholder="e.g., 1G1ZE5ST0GF253821" style="flex:2">
      <input id="mileage" type="number" min="0" step="1" placeholder="Current mileage" style="flex:1">
      <button onclick="lookup()">Lookup</button>
    </div>
    <div id="decodedBanner" class="muted" style="margin-top:6px"></div>
    <div id="results" class="grid"></div>
  </div>

  <div class="card">
    <div class="muted" style="text-transform:uppercase; letter-spacing:.12em">Carfax</div>
    <h3 style="margin-top:6px">Upload Carfax PDF</h3>
    <div class="row" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
      <input type="file" id="carfax" accept="application/pdf,image/*">
      <button onclick="uploadCarfax()">Upload</button>
      <button onclick="ocrLocal()">OCR scanned PDF</button>
      <div id="carfaxSpin" class="muted" style="display:none">Uploading…</div>
    </div>
    <div id="carfaxUrl" class="muted"></div>
    <div id="carfaxSummaryBox"></div>
    <details style="margin-top:12px"><summary class="muted">Paste Carfax text (if your PDF is scanned)</summary>
      <textarea id="carfaxPaste" rows="6" style="width:100%" placeholder="Paste Carfax text here..."></textarea>
      <div><button onclick="summarizeCarfaxText()">Summarize Text</button></div>
    </details>
  </div>

  <script>
    let valuation=null, history=null, maintenance=null, carfaxUrl=null, carfaxSummary=null, carfaxText='';
    let adjustedWholesale=null, gapItems=[];

    function toggleTheme(){ const root=document.body; const cur=root.getAttribute('data-theme')||'light'; const next=cur==='light'?'dark':'light'; root.setAttribute('data-theme',next); document.getElementById('themeBtn').textContent = next==='light'?'Dark mode':'Light mode'; }
    const money = n => '$'+Number(n||0).toLocaleString();
    function vehicleBanner(d){ const y=d?.year||'—', make=d?.make||'—', model=d?.model||'—', trim=d?.trim||''; const miles=document.getElementById('mileage').value; const label=[y,make,model,trim].filter(Boolean).join(' '); return `<div class="card" style="padding:14px; border:2px solid var(--accent)"><strong style="font-size:18px">${label}</strong>${d?.bodyClass?` · ${d.bodyClass}`:''}${miles?` · ${Number(miles).toLocaleString()} mi`:''}</div>`; }

    function valueBox(v){
      const w = (v && v.wholesale!==undefined) ? money(v.wholesale) : '—';
      const r = (v && v.retail!==undefined) ? money(v.retail) : '—';
      const adjRow = (adjustedWholesale!=null) ? `<div class="stat"><span><strong>Maintenance deduction</strong></span><span>-${money(gapItems.reduce((s,it)=>s+Number(it.amount||0),0))}</span></div><div class="stat"><span><strong>Wholesale (after gaps)</strong></span><span>${money(adjustedWholesale)}</span></div>` : '';
      return `<div><h4>Value</h4><div class="card" style="padding:8px"><div class="stat"><span><strong>Wholesale</strong></span><span>${w}</span></div><div class="stat"><span><strong>Retail</strong></span><span>${r}</span></div>${adjRow}</div><div><button onclick="applyMaintenanceDeduction()">Apply Carfax Maintenance Deduction</button></div><details class="muted" style="margin-top:8px"><summary>Raw valuation data</summary><pre>${JSON.stringify(v, null, 2)}</pre></details></div>`;
    }
    function historyBox(h){ const acc=h?.accidents??'—', owners=h?.owners??'—', svc=h?.serviceRecords??'—'; return `<div><h4>History</h4><div class="card" style="padding:8px"><div class="stat"><span><strong>Accidents</strong></span><span>${acc}</span></div><div class="stat"><span><strong>Owners</strong></span><span>${owners}</span></div><div class="stat"><span><strong>Service Records</strong></span><span>${svc}</span></div></div></div>`; }
    function maintenanceBox(m){ const up=(m&&Array.isArray(m.upcoming))?m.upcoming.map(x=>`<li>${x}</li>`).join(''):'<li>—</li>'; const intervals=(m&&m.intervals)?Object.entries(m.intervals).map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join(''):''; return `<div><h4>Maintenance</h4><div class="card" style="padding:8px"><div><strong>Upcoming</strong></div><ul>${up}</ul><div style="margin-top:6px"><strong>Intervals</strong></div><ul>${intervals}</ul></div></div>`; }

    async function lookup(){
      const vin=document.getElementById('vin').value.trim(); if(!vin) return alert('Enter a VIN');
      // decode
      try {
        const d = await fetch(`/api/vin/${encodeURIComponent(vin)}`).then(r=>r.json());
        if (d && d.ok) { window._decodedYear = Number(d.year||0); document.getElementById('decodedBanner').innerHTML = vehicleBanner(d); }
      } catch {}
      // value/history/maintenance
      const miles = Number(document.getElementById('mileage').value||0);
      const year = window._decodedYear || 0;
      valuation = await fetch(`/api/value/${vin}?mileage=${encodeURIComponent(miles)}&year=${encodeURIComponent(year)}`).then(r=>r.json());
      history = await fetch(`/api/history/${vin}`).then(r=>r.json());
      maintenance = await fetch(`/api/maintenance/${vin}`).then(r=>r.json());
      adjustedWholesale=null; gapItems=[];
      document.getElementById('results').innerHTML = valueBox(valuation) + historyBox(history) + maintenanceBox(maintenance);
    }

    async function uploadCarfax(){
      const file=document.getElementById('carfax').files[0]; if(!file) return alert('Choose a PDF first');
      const fd=new FormData(); fd.append('file', file); document.getElementById('carfaxSpin').style.display='inline';
      const res=await fetch('/api/carfax/upload',{method:'POST',body:fd}).then(r=>r.json()).catch(()=>null);
      document.getElementById('carfaxSpin').style.display='none';
      if(!res){ alert('Upload failed'); return; }
      if(res.url){ carfaxUrl=res.url; document.getElementById('carfaxUrl').innerHTML=`Uploaded: <a href="${res.url}" target="_blank">${res.url}</a>`; }
      carfaxSummary=res.summary; carfaxText=res.text||'';
      if(carfaxSummary && !carfaxSummary.note){ document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
      else { document.getElementById('carfaxSummaryBox').innerHTML = `<div class="card"><strong>Carfax Summary</strong><div class="muted">No text extracted. Use <b>OCR scanned PDF</b> or paste the text below.</div></div>`; }
    }

    async function ocrLocal(){
      const file=document.getElementById('carfax').files[0]; if(!file) return alert('Choose a PDF or image first');
      const isPdf = /pdf$/i.test(file.type) || /\.pdf$/i.test(file.name);
      document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">OCR in progress…</div>';
      let text = '';
      if (!isPdf) {
        const imgURL = URL.createObjectURL(file);
        const { data: { text: ocrText } } = await Tesseract.recognize(imgURL, 'eng');
        text = ocrText; URL.revokeObjectURL(imgURL);
      } else {
        const arrayBuf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuf }).promise;
        const maxPages = Math.min(pdf.numPages, 5);
        for (let p = 1; p <= maxPages; p++) {
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({ scale: 1.5 });
          const canvas = document.createElement('canvas');
          canvas.width = viewport.width; canvas.height = viewport.height;
          await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
          const { data: { text: otext } } = await Tesseract.recognize(canvas, 'eng');
          text += '\\n\\n' + otext;
        }
      }
      if (!text.trim()) { document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">OCR returned no text.</div>'; return; }
      const res = await fetch('/api/carfax/summarize-text', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: text }) }).then(r=>r.json());
      if (res.ok) { carfaxSummary = res.summary; document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
      else { document.getElementById('carfaxSummaryBox').innerHTML = '<div class="muted">Failed to summarize OCR text.</div>'; }
    }

    function carfaxBox(s){
      const entries = Object.entries(s||{}).filter(([k,v]) => k!=='note' && v && ((Array.isArray(v)&&v.length) || (!Array.isArray(v))));
      if (!entries.length) return '<div class="card"><em>No Carfax summary extracted.</em></div>';
      const html = entries.map(([k,v]) => `<div class="stat"><span><strong>${k}</strong></span><span>${Array.isArray(v)?v.join(', '):String(v)}</span></div>`).join('');
      return `<div class="card"><div class="muted" style="text-transform:uppercase;letter-spacing:.12em">Carfax</div><h3>Summary</h3>${html}</div>`;
    }

    async function summarizeCarfaxText(){
      const raw = document.getElementById('carfaxPaste').value || '';
      if (!raw.trim()) return alert('Paste some text first');
      const res = await fetch('/api/carfax/summarize-text', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: raw }) }).then(r=>r.json());
      if (res.ok){ carfaxSummary = res.summary; document.getElementById('carfaxSummaryBox').innerHTML = carfaxBox(carfaxSummary); }
      else alert('Could not summarize pasted text');
    }

    async function applyMaintenanceDeduction(){
      if (!valuation) return alert('Run a VIN lookup first.');
      const body = { baseWholesale: Number(valuation?.wholesale||0), carfaxSummary: carfaxSummary||{}, carfaxText: carfaxText||'', mileage: Number(document.getElementById('mileage').value||0), year: (window._decodedYear||0) || 0 };
      const res = await fetch('/api/value/adjusted', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
      if (!res.ok) return alert('Could not calculate maintenance deduction');
      adjustedWholesale = res.adjustedWholesale; gapItems = res.items||[];
      document.getElementById('results').innerHTML = valueBox(valuation) + historyBox(history) + maintenanceBox(maintenance);
    }
  </script>
</body>
</html>
