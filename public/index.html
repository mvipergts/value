<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Car Value, History & Maintenance — Pro v6.2.7</title>
  <style>
:root{ --bg:#f7fafc; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569; --primary:#2563eb; --border:#d6e0ee; --accent:#e2e8f0; --green:#10b981; --amber:#f59e0b; --indigo:#6366f1; }
*{ box-sizing:border-box; }
body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); }
.wrap{ max-width:1200px; margin:20px auto; padding:0 16px; }
h1{ margin:0 0 14px; }
.muted{ color:var(--muted); }
.card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(12,28,70,.06); }
.btn{ background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px 14px; box-shadow:0 2px 10px rgba(12,28,70,.06); cursor:pointer; font-weight:600; }
.btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff; }
.btn:disabled{ opacity:.6; cursor:not-allowed; }
input,select{ border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
.stat{ display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed var(--accent); }
.stat:last-child{ border-bottom:none; }
.grid{ display:grid; grid-template-columns: repeat(3,1fr); gap:14px; }
.grid.grid-3{ grid-template-columns:minmax(0,1fr) minmax(0,1fr) minmax(0,0.85fr); align-items:start; }
@media (max-width:1200px){ .grid.grid-3{ grid-template-columns:1fr; } }
.grid>.card, .grid.grid-3>.card{ min-width:0; }
.grow{ flex:1 1 0; min-width:0; }
.risks{ max-height:560px; overflow:auto; word-break:break-word; }
.risks details{ border:1px dashed var(--accent); border-radius:10px; padding:6px 8px; margin:6px 0; background:#fff; }
.risks summary{ cursor:pointer; }
.sticky{ position:sticky; top:0; z-index:10; background:rgba(247,250,252,.9); backdrop-filter:saturate(180%) blur(6px); padding:8px 0; border-bottom:1px solid var(--border); }
.badge{ display:inline-block; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid var(--border); margin-right:8px; box-shadow:0 1px 6px rgba(0,0,0,.05); }
  </style>
</head>
<body>
  <div class="sticky">
    <div class="wrap">
      <span id="sVehicle" class="badge muted">Vehicle</span>
      <span class="badge">Summary:</span>
      <span class="badge">Retail: <span id="sumRetail">$0</span></span>
      <span class="badge">Wholesale: <span id="sumWhole">$0</span></span>
      <span class="badge">Maint: <span id="sumMaint">$0</span></span>
      <span class="badge">Recon: <span id="sumRecon">$0</span></span>
      <span class="badge">Risk: <span id="sumRisk">$0</span></span>
      <span class="badge">Max Buy: <span id="sumMax">$0</span></span>
      <button class="btn" onclick="openSettings()">Settings</button>
      <button class="btn primary" onclick="window.print()">Print Customer PDF</button>
    </div>
  </div>

  <div class="wrap">
    <h1>Car Value, History & Maintenance — Pro v6.2.7</h1>

    <!-- Step 1 -->
    <div class="card" id="step1">
      <h3>1) Identify</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <input id="vin" placeholder="VIN" style="min-width:260px">
        <input id="miles" type="number" min="0" placeholder="Mileage">
        <button class="btn primary" onclick="lookupVIN()">Lookup</button>
      </div>
      <div id="vehicleBanner" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- Step 3 (Service & Recon) -->
    <div class="card" id="step3" style="margin-top:14px; display:none">
      <h3>3) Service & Recon</h3>
      <div class="grid grid-3">
        <div class="card">
          <button class="btn primary" onclick="applyMaint()">Apply Maintenance (from Carfax)</button>
          <button class="btn" onclick="getEvidence()">Get NHTSA + TSB Evidence</button>
          <h4 style="margin-top:12px">Maintenance Deductions</h4>
          <table style="width:100%">
            <thead><tr><th align="left">Item</th><th align="left">Amount</th><th align="left">Why</th></tr></thead>
            <tbody id="maintTable"></tbody>
          </table>
        </div>

        <div class="card">
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn">+ Tires</button>
            <button class="btn">+ Windshield</button>
            <button class="btn">+ Detail</button>
            <button class="btn">+ Inspection</button>
            <button class="btn">+ Alignment</button>
            <button class="btn">+ Brakes</button>
            <button class="btn">+ Battery</button>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px">
            <input id="reconLabel" class="grow" placeholder="Custom item">
            <input id="reconAmt" class="grow" type="number" min="0" step="1" placeholder="Amount" style="max-width:220px">
            <button class="btn" onclick="addRecon()">Add</button>
          </div>
          <table style="width:100%; margin-top:10px">
            <thead><tr><th align="left">Item</th><th align="left">Cost</th></tr></thead>
            <tbody id="reconTable"><tr><td class="muted">No additional costs.</td><td>$0</td></tr></tbody>
          </table>
        </div>

        <div class="card risks">
          <div class="badge muted" id="riskCounts">Recalls 0 • Complaints 0 • TSBs 0</div>
          <button class="btn primary" style="margin-top:8px" onclick="applyRisks()">Apply Top Risks to Recon</button>
          <div id="riskList" style="margin-top:8px" class="muted">No data yet.</div>
        </div>
      </div>
    </div>

    <!-- Step 4 (Offer) -->
    <div class="card" id="step4" style="margin-top:14px; display:none">
      <h3>4) Offer + Market Comps</h3>
      <div class="grid">
        <div class="card">
          <h4>Numbers</h4>
          <div class="stat"><span><strong>Retail</strong></span><span id="oRetail">$0</span></div>
          <div class="stat"><span><strong>Wholesale</strong></span><span id="oWhole">$0</span></div>
          <div class="stat"><span><strong>Maint. deduction</strong></span><span id="oMaint">$0</span></div>
          <div class="stat"><span><strong>Wholesale (after)</strong></span><span id="oAdj">$0</span></div>
          <div class="stat"><span><strong>Recon total</strong></span><span id="oRecon">$0</span></div>
          <div class="stat"><span><strong>Risk reserve</strong></span><span id="oRisk">$0</span></div>
          <div class="stat"><span><strong>Desired profit</strong></span><span id="oProfit">$0</span></div>
          <div class="stat"><span><strong>Holding & fees</strong></span><span id="oHold">$0</span></div>
          <div class="stat"><span><strong>Target Max Buy</strong></span><span id="oMax">$0</span></div>
        </div>
        <div class="card" id="ebayCard">
          <h4>eBay Comps (Free)</h4>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <input id="zip" placeholder="ZIP (optional)" style="width:140px">
            <select id="radius">
              <option value="100">100 mi</option>
              <option value="250">250 mi</option>
              <option value="500" selected>500 mi</option>
            </select>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
            <button class="btn" onclick="fetchEbay('sold')">Fetch SOLD</button>
            <button class="btn" onclick="fetchEbay('active')">Fetch ACTIVE</button>
            <button class="btn" onclick="useSoldMedian()">Use SOLD Median as Retail</button>
          </div>
          <div id="ebayStats" class="muted" style="margin-top:8px">—</div>
          <details style="margin-top:6px"><summary>Sold list</summary><div id="soldList" class="muted">No results</div></details>
          <details style="margin-top:6px"><summary>Active list</summary><div id="activeList" class="muted">No results</div></details>
        </div>
        <div class="card" id="carsCard">
          <h4>Cars.com (Optional)</h4>
          <div class="muted" style="margin-bottom:6px">Uses SerpAPI if <code>SERPAPI_KEY</code> is set. Otherwise, paste comps manually below.</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" onclick="fetchSerp('cars')">Fetch Cars.com</button>
            <button class="btn" onclick="useCarsMedian()">Use Cars.com Median as Retail</button>
          </div>
          <div id="carsStats" class="muted" style="margin-top:6px">—</div>
          <details style="margin-top:6px"><summary>Results</summary><div id="carsList" class="muted">No results</div></details>
          <details style="margin-top:6px"><summary>Paste comps (price - title - url)</summary>
            <textarea id="carsManual" style="width:100%; min-height:100px"></textarea>
            <div style="margin-top:6px"><button class="btn" onclick="parseCarsManual()">Parse</button></div>
          </details>
        </div>
        <div class="card" id="fbCard">
          <h4>Facebook Marketplace (Manual / Optional)</h4>
          <div class="muted">Paste comps (no automated scraping here).</div>
          <details open style="margin-top:6px"><summary>Paste comps</summary>
            <textarea id="fbManual" style="width:100%; min-height:100px"></textarea>
            <div style="margin-top:6px"><button class="btn" onclick="parseFbManual()">Parse</button> <button class="btn" onclick="useFbMedian()">Use FB Median as Retail</button></div>
          </details>
          <div id="fbStats" class="muted" style="margin-top:6px">—</div>
          <details style="margin-top:6px"><summary>Results</summary><div id="fbList" class="muted">No results</div></details>
        </div>
        <div class="card" id="guideCard">
          <h4>Guides: KBB / Black Book / Manual</h4>
          <div class="muted">Enter guide numbers if you have them (or use manual).</div>
          <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px">
            <div class="card">
              <h5>KBB</h5>
              <div>Retail <input id="kbbRetail" type="number" min="0" style="width:140px"></div>
              <div>Wholesale <input id="kbbWhole" type="number" min="0" style="width:140px"></div>
            </div>
            <div class="card">
              <h5>Black Book</h5>
              <div>Retail <input id="bbRetail" type="number" min="0" style="width:140px"></div>
              <div>Wholesale <input id="bbWhole" type="number" min="0" style="width:140px"></div>
            </div>
          </div>
          <div style="margin-top:8px">
            <div>Manual Retail <input id="manRetail" type="number" min="0" style="width:160px"> 
            <button class="btn" onclick="useGuidesWeighted()">Use Weighted Retail</button></div>
            <div class="muted" style="margin-top:6px">Weights: SOLD median 0.5, Cars.com 0.2, KBB 0.15, Black Book 0.1, Manual 0.05 (only sources you provide are used).</div>
          </div>
        </div>
        <div class="card">
          <h4>Proof</h4>
          <div id="proofCarfaxPretty" class="card"></div>
          <details><summary class="muted">Carfax summary (raw)</summary><pre id="proofCarfax"></pre></details>
          <details><summary class="muted">Evidence (raw)</summary><pre id="proofEvidence"></pre></details>
        </div>
      </div>
    </div>
  </div>

<script>
let vehicle = {}; let maintItems = []; let reconItems = []; let carfaxSummary={};

function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent=v; }
function fmt(n){ return '$'+Number(n||0).toLocaleString(); }

async function lookupVIN(){
  const vin = document.getElementById('vin').value.trim();
  const miles = Number(document.getElementById('miles').value||0);
  if(!vin) return;
  // Decode basic via VPIC (through server evidence endpoint will also decode)
  const dec = await fetch('/api/evidence/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vin})}).then(r=>r.json());
  if(dec.ok){
    vehicle = dec.vehicle || {};
    document.getElementById('sVehicle').textContent = `${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}${miles?(' • '+miles.toLocaleString()+' mi'):''}`.trim();
    document.getElementById('vehicleBanner').innerHTML = `<strong>${vehicle.year||''} ${vehicle.make||''} ${vehicle.model||''}</strong>${vehicle.bodyClass?(' · '+vehicle.bodyClass):''}${miles?(' · '+miles.toLocaleString()+' mi'):''}`;
    // evidence from this call
    renderEvidence(dec);
  }
  const maint = await fetch(`/api/maintenance/${vin}`).then(r=>r.json());
  document.getElementById('step3').style.display='block';
  document.getElementById('step4').style.display='block';
  // Auto refresh offer after each stage
  refreshOffer();
}

function renderEvidence(res){
  document.getElementById('riskCounts').textContent = `Recalls ${res.counts?.recalls||0} • Complaints ${res.counts?.complaints||0} • TSBs ${res.counts?.tsbs||0}`;
  const defaults = {
    'Engine / Oil consumption': ['Check oil use (qt/1k mi); blue smoke; fouled plugs','Scan for misfire codes; PCV/valve cover leaks'],
    'Transmission': ['2–3 shift flare/judder test; harshness','CVT low-speed judder/whine; verify fluid service history'],
    'Electrical': ['Battery/alternator load test; parasitic draw check'],
    'Brakes': ['Measure pad/rotor thickness; brake pulsation test'],
    'HVAC / A/C': ['Vent temp at idle/cruise; blend door operation']
  };
  const list = (res.topRisks||[]).map(r=>{
    const checks = (r.checks?.length?r.checks:defaults[r.label]||[]).map(c=>`<li>${c}</li>`).join('');
    return `<details class="risk"><summary><strong>${r.label}</strong> — score ${r.score}</summary>
      <div class="muted">${r.rationale||''}</div>
      <ul>${checks}</ul>
    </details>`;
  }).join('') || '<div class="muted">No notable risks.</div>';
  document.getElementById('riskList').innerHTML = list;
  document.getElementById('proofEvidence').textContent = JSON.stringify(res,null,2);
}

async function getEvidence(){
  const vin = document.getElementById('vin').value.trim();
  const res = await fetch('/api/evidence/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({vin})}).then(r=>r.json());
  if(res.ok) renderEvidence(res);
}

function applyMaint(){
  // Example maintenance items
  maintItems = [
    { label:'Oil change', amount:60, why:'Low service history • No oil change found in Carfax text' },
    { label:'Engine air filter', amount:45, why:'Low service history' },
    { label:'Cabin filter', amount:40, why:'Low service history' },
    { label:'Transmission service', amount:250, why:'>=60k mi and no service noted' }
  ];
  renderMaint();
  refreshOffer();
}
function renderMaint(){
  const tbody = document.getElementById('maintTable');
  tbody.innerHTML = maintItems.map(i=>`<tr><td>${i.label}</td><td>${fmt(i.amount)}</td><td>${i.why||''}</td></tr>`).join('');
}

function addRecon(){
  const label = document.getElementById('reconLabel').value.trim();
  const amt = Number(document.getElementById('reconAmt').value||0);
  if(!label || !amt){ return; }
  reconItems.push({ label, amount:amt });
  const tbody = document.getElementById('reconTable');
  tbody.innerHTML = reconItems.map(i=>`<tr><td>${i.label}</td><td>${fmt(i.amount)}</td></tr>`).join('');
  refreshOffer();
}

function renderCarfaxPretty(sum){
  if(!sum || Object.keys(sum).length===0){
    document.getElementById('proofCarfaxPretty').innerHTML='<span class="muted">No Carfax summary.</span>'; return;
  }
  const rows = [
    ['Accidents', sum.accidents],
    ['Damage Reports', sum.damageReports],
    ['Owners', sum.owners],
    ['Service Records', sum.serviceRecords],
    ['Recalls', sum.recalls],
    ['Last Odometer', sum.lastOdometer||'—'],
    ['Usage', sum.usage||'—'],
    ['Brandings', (Array.isArray(sum.brandings)&&sum.brandings.length)? sum.brandings.join(', ') : '—']
  ];
  document.getElementById('proofCarfaxPretty').innerHTML =
    '<table style="width:100%">'+rows.map(r=>`<tr><td class="muted">${r[0]}</td><td><strong>${r[1]??'—'}</strong></td></tr>`).join('')+'</table>';
}

function refreshOffer(){
  const retailBase = 10000; // placeholder value source
  const wholesaleBase = 9040; // placeholder value source
  const maintDeduction = maintItems.reduce((s,i)=>s+(i.amount||0),0);
  const reconTotal = reconItems.reduce((s,i)=>s+(i.amount||0),0);
  // Risk reserve from current evidence counts (simple example: $80 per recall)
  const risk = document.getElementById('riskCounts').textContent;
  const recallMatch = /Recalls\s+(\d+)/.exec(risk);
  const recallCount = recallMatch? Number(recallMatch[1]) : 0;
  const riskReserve = recallCount * 80;

  fetch('/api/offer/calc', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ retailBase, wholesaleBase, maintDeduction, reconTotal, riskReserve })
  }).then(r=>r.json()).then(calc=>{
    if(!calc.ok) return;
    calc = calc.numbers;
    setText('oRetail', fmt(calc.retailBase));
    setText('oWhole', fmt(calc.wholesaleBase));
    setText('oMaint', '-'+fmt(maintDeduction));
    setText('oAdj', fmt(calc.adjWholesale));
    setText('oRecon', fmt(calc.reconTotal));
    setText('oRisk', fmt(calc.riskReserve));
    setText('oProfit', fmt(calc.desiredProfit||0));
    setText('oHold', fmt((calc.holding||0)+(calc.fees||0)));
    setText('oMax', fmt(calc.targetMaxBuy));

    // summary badges
    setText('sumRetail', fmt(calc.retailBase));
    setText('sumWhole', fmt(calc.wholesaleBase));
    setText('sumMaint', '-'+fmt(maintDeduction));
    setText('sumRecon', fmt(reconTotal));
    setText('sumRisk', fmt(calc.riskReserve));
    setText('sumMax', fmt(calc.targetMaxBuy));
  });
}

async function fetchEbay(kind){
  const year = vehicle.year||''; const make = vehicle.make||''; const model = vehicle.model||'';
  const zip = (document.getElementById('zip')||{value:''}).value.trim();
  const radius = (document.getElementById('radius')||{value:'500'}).value;
  const qs = new URLSearchParams({ year, make, model, zip, radius, type: kind }).toString();
  const res = await fetch(`/api/ebay/comps?${qs}`).then(r=>r.json());
  if(!res.ok){ (document.getElementById('ebayStats')||{}).textContent = res.error||'No results'; return; }
  const s = res.stats||{};
  const line = `${kind.toUpperCase()} — n=${s.count||0} • median ${fmt(Math.round(s.median||0))} • avg ${fmt(Math.round(s.avg||0))} • range ${fmt(s.min||0)}–${fmt(s.max||0)}`;
  (document.getElementById('ebayStats')||{}).textContent = line;
  const items = (res.items||[]).slice(0,20).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0"><a href="${x.url}" target="_blank">${x.title}</a> — <strong>${fmt(x.price)}</strong> <span class="muted">${x.loc||''}</span></div>`).join('') || '<div class="muted">No results.</div>';
  if(kind==='sold'){ (document.getElementById('soldList')||{}).innerHTML = items; window._lastSoldMedian = Math.round(s.median||0); }
  else { (document.getElementById('activeList')||{}).innerHTML = items; }
}
function useSoldMedian(){
  if(!window._lastSoldMedian){ alert('Fetch SOLD comps first.'); return; }
  window._retailBase = window._lastSoldMedian;
  refreshOffer();
}

async function fetchSerp(site){
  const zip = (document.getElementById('zip')||{value:''}).value.trim();
  const year = vehicle.year||''; const make = vehicle.make||''; const model = vehicle.model||'';
  const qs = new URLSearchParams({ site, year, make, model, zip }).toString();
  const res = await fetch(`/api/serp/comps?${qs}`).then(r=>r.json());
  if(!res.ok){ (site==='cars'?carsStats:fbStats).textContent = res.error||'No results'; return; }
  const s = res.stats||{};
  const line = `n=${s.count||0} • median ${fmt(Math.round(s.median||0))} • avg ${fmt(Math.round(s.avg||0))} • range ${fmt(s.min||0)}–${fmt(s.max||0)}`;
  if(site==='cars'){
    document.getElementById('carsStats').textContent = line;
    document.getElementById('carsList').innerHTML = (res.items||[]).slice(0,20).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0"><a href="${x.url}" target="_blank">${x.title}</a> — <strong>${fmt(x.price)}</strong></div>`).join('') || '<div class="muted">No results.</div>';
    window._carsMedian = Math.round(s.median||0);
  }else{
    document.getElementById('fbStats').textContent = line;
    document.getElementById('fbList').innerHTML = (res.items||[]).slice(0,20).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0"><a href="${x.url}" target="_blank">${x.title}</a> — <strong>${fmt(x.price)}</strong></div>`).join('') || '<div class="muted">No results.</div>';
    window._fbMedian = Math.round(s.median||0);
  }
}
function parseCarsManual(){
  const text = (document.getElementById('carsManual')||{value:''}).value;
  fetch('/api/comps/manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
    .then(r=>r.json()).then(res=>{
      if(!res.ok){ document.getElementById('carsStats').textContent='Could not parse'; return; }
      const s = res.stats||{};
      document.getElementById('carsStats').textContent = `Manual — n=${s.count} • median ${fmt(Math.round(s.median||0))}`;
      document.getElementById('carsList').innerHTML = (res.items||[]).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0">${x.title} — <strong>${fmt(x.price)}</strong> ${x.url?('<a href="'+x.url+'" target="_blank">link</a>'):''}</div>`).join('') || '<div class="muted">No results.</div>';
      window._carsMedian = Math.round(s.median||0);
    });
}
function parseFbManual(){
  const text = (document.getElementById('fbManual')||{value:''}).value;
  fetch('/api/comps/manual',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})})
    .then(r=>r.json()).then(res=>{
      if(!res.ok){ document.getElementById('fbStats').textContent='Could not parse'; return; }
      const s = res.stats||{};
      document.getElementById('fbStats').textContent = `Manual — n=${s.count} • median ${fmt(Math.round(s.median||0))}`;
      document.getElementById('fbList').innerHTML = (res.items||[]).map(x=>`<div style="border-bottom:1px dashed var(--accent); padding:4px 0">${x.title} — <strong>${fmt(x.price)}</strong> ${x.url?('<a href="'+x.url+'" target="_blank">link</a>'):''}</div>`).join('') || '<div class="muted">No results.</div>';
      window._fbMedian = Math.round(s.median||0);
    });
}
function useCarsMedian(){ if(window._carsMedian){ window._retailBase = window._carsMedian; refreshOffer(); } else alert('Fetch or paste Cars.com comps first.'); }
function useFbMedian(){ if(window._fbMedian){ window._retailBase = window._fbMedian; refreshOffer(); } else alert('Add FB comps first.'); }

function useGuidesWeighted(){
  const kbbR = Number((document.getElementById('kbbRetail')||{value:0}).value||0);
  const bbR  = Number((document.getElementById('bbRetail')||{value:0}).value||0);
  const manR = Number((document.getElementById('manRetail')||{value:0}).value||0);
  const sold = Number(window._lastSoldMedian||0);
  const cars = Number(window._carsMedian||0);
  const vals = [];
  if(sold) vals.push({w:.5, v:sold});
  if(cars) vals.push({w:.2, v:cars});
  if(kbbR) vals.push({w:.15, v:kbbR});
  if(bbR)  vals.push({w:.1, v:bbR});
  if(manR) vals.push({w:.05, v:manR});
  if(!vals.length){ alert('Provide at least one source.'); return; }
  const sumW = vals.reduce((s,x)=>s+x.w,0);
  const blended = Math.round(vals.reduce((s,x)=>s+x.w*x.v,0)/sumW);
  window._retailBase = blended;
  refreshOffer();
}
</script>
</body>
</html>
