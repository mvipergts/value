<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Car Value, History & Maintenance — Pro v6.2.2</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{ --bg:#f7fafc; --surface:#fff; --card:#fff; --text:#0f172a; --muted:#475569; --primary:#2563eb; --border:#d6e0ee; --accent:#e2e8f0; --green:#10b981; --amber:#f59e0b; --indigo:#6366f1; }
*{ box-sizing:border-box; }
body{ font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto; margin:0; background:linear-gradient(180deg,#eef2ff 0%, #f8fafc 28%); color:var(--text); }
.container{ max-width:1100px; margin:0 auto; padding:24px; }
h1{ margin:0 0 8px 0; }
small.muted{ color:var(--muted); }
.card{ border:1px solid var(--border); background:linear-gradient(180deg, var(--card), var(--surface)); border-radius:16px; padding:16px; margin-top:14px; }
.grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
input, button, textarea, select{ padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:var(--surface); color:var(--text); font-size:15px; }
.btn{ background:var(--primary); color:#fff; border:1px solid var(--primary); border-radius:12px; padding:12px 18px; font-weight:800; box-shadow:0 6px 18px rgba(37,99,235,.22); cursor:pointer; }
.btn.ghost{ background:#fff; color:var(--primary); }
.badge{ padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--accent); background:#fff; }
.stat{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed var(--accent); }
.stat:last-child{ border-bottom:0; }
summary{ cursor:pointer; }
.hidden{ display:none; }
table{ width:100%; border-collapse:collapse; }
thead th{ text-align:left; background:rgba(2,6,23,.03); padding:8px; }
tbody td{ padding:8px; border-bottom:1px dashed var(--accent); }
tfoot td{ padding:8px; }

#sticky{ position:sticky; top:0; z-index:5; background: rgba(255,255,255,.86); backdrop-filter: blur(6px); border-bottom:1px solid var(--border); }
#sticky .wrap{ max-width:1100px; margin:0 auto; padding:10px 24px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.pill{ border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:999px; font-weight:700; }
.pill.blue{ border-color:rgba(37,99,235,.35); background:rgba(37,99,235,.08); }

#wizardNav{ display:flex; gap:8px; margin-top:8px; }
.step{ padding:8px 14px; border-radius:12px; border:1px solid var(--border); }
.step.active{ background:rgba(37,99,235,.1); border-color:var(--primary); }

.modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; }
.modal .panel{ width:720px; max-width:94vw; background:#fff; border-radius:14px; padding:18px; }
.modal .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>if (window.pdfjsLib) { pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"; }</script>
<script src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body>
<div id="sticky">
  <div class="wrap">
    <strong>Summary:</strong>
    <span class="pill">Retail: <span id="sRetail">$0</span></span>
    <span class="pill">Wholesale: <span id="sWhole">$0</span></span>
    <span class="pill">Maint: <span id="sMaint">-$0</span></span>
    <span class="pill">Recon: <span id="sRecon">$0</span></span>
    <span class="pill">Risk: <span id="sRisk">$0</span></span>
    <span class="pill blue">Max Buy: <span id="sMax">$0</span></span>
    <button class="btn ghost" onclick="openSettings()">Settings</button>
    <button class="btn" onclick="printPdf()">Print Customer PDF</button>
  </div>
</div>

<div class="container">
  <h1>Car Value, History & Maintenance — Pro v6.2.2</h1>
  <div id="wizardNav">
    <div class="step active" id="step1Btn" onclick="showStep(1)">1) Identify</div>
    <div class="step" id="step2Btn" onclick="showStep(2)">2) History</div>
    <div class="step" id="step3Btn" onclick="showStep(3)">3) Service & Recon</div>
    <div class="step" id="step4Btn" onclick="showStep(4)">4) Offer + Comps</div>
  </div>

  <div id="step1" class="card">
    <h3>Identify</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <input id="vin" placeholder="VIN">
      <input id="miles" type="number" min="0" step="1" placeholder="Current mileage">
      <button class="btn" onclick="lookup()">Lookup</button>
    </div>
    <div id="vehicleBanner" class="card" style="margin-top:10px"></div>
    <div class="grid">
      <div class="card">
        <div class="stat"><span><strong>Retail</strong></span><span id="vRetail">$0</span></div>
        <div class="stat"><span><strong>Wholesale</strong></span><span id="vWholesale">$0</span></div>
        <details><summary class="muted">Raw valuation</summary><pre id="valRaw"></pre></details>
      </div>
      <div class="card">
        <div class="badge" id="histBadges">Accidents 0 • Owners 0 • Records 0</div>
        <details><summary class="muted">Raw history</summary><pre id="histRaw"></pre></details>
      </div>
      <div class="card">
        <div class="badge">Intervals</div>
        <ul id="intervals"></ul>
      </div>
    </div>
  </div>

  <div id="step2" class="card hidden">
    <h3>History</h3>
    <div class="card">
      <label>Upload Carfax / AutoCheck (PDF)</label>
      <div style="display:flex; gap:10px; align-items:center">
        <input type="file" id="carfax" accept="application/pdf">
        <button class="btn" onclick="uploadCarfax()">Upload</button>
        <button class="btn ghost" onclick="ocrCarfaxFromFile()">Scan with OCR</button>
      </div>
      <div id="carfaxUrl" class="muted"></div>
      <div id="carfaxBox" class="card"></div>
      <details><summary class="muted">Paste text (for scanned PDFs)</summary>
        <textarea id="carfaxPaste" rows="6" style="width:100%"></textarea>
        <div><button class="btn ghost" onclick="summarizeText()">Summarize Text</button></div>
      </details>
    </div>
  </div>

  <div id="step3" class="card hidden">
    <h3>Service & Recon</h3>
    <div class="grid">
      <div class="card">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <button class="btn" onclick="applyMaintenance()">Apply Maintenance (from Carfax)</button>
          <button class="btn ghost" onclick="getEvidence()">Get NHTSA + TSB Evidence</button>
        </div>
        <h4 style="margin-top:10px">Maintenance Deductions</h4>
        <table>
          <thead><tr><th>Item</th><th style="text-align:right">Amount</th><th>Why</th></tr></thead>
          <tbody id="maintRows"><tr><td class="muted" colspan="3">No items yet.</td></tr></tbody>
          <tfoot><tr><td style="text-align:right"><strong>Total</strong></td><td style="text-align:right" id="maintTotal">$0</td><td></td></tr></tfoot>
        </table>
      </div>
      <div class="card">
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn ghost" onclick="quick('Tires (set)', 800, 'tires')">+ Tires</button>
          <button class="btn ghost" onclick="quick('Windshield', 300, 'glass')">+ Windshield</button>
          <button class="btn ghost" onclick="quick('Detail', 150, 'detail')">+ Detail</button>
          <button class="btn ghost" onclick="quick('Inspection', 120, 'inspection')">+ Inspection</button>
          <button class="btn ghost" onclick="quick('Alignment', 110, 'wheel_alignment')">+ Alignment</button>
          <button class="btn ghost" onclick="quick('Brakes (pads/rotors est.)', 450, 'brakes')">+ Brakes</button>
          <button class="btn ghost" onclick="quick('Battery', 180, 'battery')">+ Battery</button>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px">
          <input id="reconLabel" placeholder="Custom item">
          <input id="reconAmt" type="number" min="0" step="1" placeholder="Amount">
          <button class="btn" onclick="addRecon()">Add</button>
        </div>
        <table style="margin-top:8px">
          <thead><tr><th>Item</th><th style="text-align:right">Cost</th><th></th></tr></thead>
          <tbody id="reconRows"><tr><td class="muted" colspan="3">No additional costs.</td></tr></tbody>
          <tfoot><tr><td style="text-align:right"><strong>Total</strong></td><td style="text-align:right" id="reconTotal">$0</td><td></td></tr></tfoot>
        </table>
      </div>
      <div class="card">
        <h4>Top Risks</h4>
        <div id="riskBadge" class="badge">Recalls 0 • Complaints 0 • TSBs 0</div>
        <ul id="riskList"></ul>
        <button class="btn ghost" onclick="applyRisksToRecon()">Apply Top Risks to Recon</button>
      </div>
    </div>
  </div>

  <div id="step4" class="card hidden">
    <h3>Offer + Market Comps</h3>
    <div class="grid">
      <div class="card">
        <h4>Numbers</h4>
        <div class="stat"><span><strong>Retail</strong></span><span id="oRetail">$0</span></div>
        <div class="stat"><span><strong>Wholesale</strong></span><span id="oWhole">$0</span></div>
        <div class="stat"><span><strong>Maint. deduction</strong></span><span id="oMaint">-$0</span></div>
        <div class="stat"><span><strong>Wholesale (after)</strong></span><span id="oAdj">$0</span></div>
        <div class="stat"><span><strong>Recon total</strong></span><span id="oRecon">$0</span></div>
        <div class="stat"><span><strong>Risk reserve</strong></span><span id="oRisk">$0</span></div>
        <div class="stat"><span><strong>Holding & fees</strong></span><span id="oHold">$0</span></div>
        <div class="stat"><span><strong>Target Max Buy</strong></span><span id="oMax" style="font-weight:800">$0</span></div>
      </div>
      <div class="card">
        <h4>eBay Comps (Free)</h4>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
          <input id="compZip" placeholder="ZIP (optional)" style="width:140px">
          <select id="compRadius">
            <option value="100">100 mi</option>
            <option value="250">250 mi</option>
            <option value="500" selected>500 mi</option>
          </select>
          <button class="btn" onclick="fetchSold()">Fetch SOLD</button>
          <button class="btn ghost" onclick="fetchActive()">Fetch ACTIVE</button>
          <button class="btn ghost" onclick="useSoldMedian()">Use SOLD Median as Retail</button>
        </div>
        <div class="stat"><span>Sold stats</span><span id="soldStats">—</span></div>
        <div class="stat"><span>Active stats</span><span id="activeStats">—</span></div>
        <details><summary>Sold list</summary><ul id="soldList"></ul></details>
        <details><summary>Active list</summary><ul id="activeList"></ul></details>
      </div>
      <div class="card">
        <h4>Proof</h4>
        <details><summary class="muted">Carfax summary</summary><pre id="proofCarfax"></pre></details>
        <details><summary class="muted">Evidence</summary><pre id="proofEvidence"></pre></details>
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h3>Dealer Settings</h3>
      <button class="btn ghost" onclick="closeSettings()">Close</button>
    </div>
    <div class="grid">
      <div class="card">
        <label>Labor rate ($/hr)</label>
        <input id="sLabor" type="number" min="0" step="1">
        <label>Parts multiplier</label>
        <input id="sParts" type="number" step="0.1">
        <label>Desired profit ($)</label>
        <input id="sProfit" type="number" min="0" step="1">
        <label>Days to turn</label>
        <input id="sDays" type="number" min="0" step="1">
      </div>
      <div class="card">
        <label>Floorplan APR (decimal)</label>
        <input id="sApr" type="number" step="0.01">
        <label>Avg transport ($)</label>
        <input id="sTrans" type="number" min="0" step="1">
        <label>Marketing fees ($)</label>
        <input id="sMkt" type="number" min="0" step="1">
        <label>Warranty reserve ($)</label>
        <input id="sWar" type="number" min="0" step="1">
      </div>
    </div>
    <div class="card">
      <h4>Risk Reserve Weights ($ per point)</h4>
      <div id="riskWeightsGrid" class="grid"></div>
      <label>Risk cap (% of wholesale)</label>
      <input id="sCap" type="number" step="0.01">
    </div>
    <div style="display:flex; justify-content:flex-end; gap:8px">
      <button class="btn ghost" onclick="closeSettings()">Cancel</button>
      <button class="btn" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script>
let valuation=null, historyData=null, maintData=null;
let carfaxUrl=null, carfaxSummary=null, carfaxText='';
let maintItems=[], reconItems=[], evidence=null, calc=null, vehicleLabel='', decoded={};

function fmt(n){ return '$'+Number(n||0).toLocaleString(); }
function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent=val; }
function showStep(n){ [1,2,3,4].forEach(i=>{ document.getElementById('step'+i).classList.toggle('hidden', i!==n); document.getElementById('step'+i+'Btn').classList.toggle('active', i===n); }); if(n===4) refreshOffer(); }

async function lookup(){
  const vin = document.getElementById('vin').value.trim();
  const miles = Number(document.getElementById('miles').value||0);
  if (!vin) return alert('Enter VIN');
  try{
    const v = await fetch('/api/vin/'+encodeURIComponent(vin)).then(r=>r.json());
    if (v && v.ok){
      decoded = v;
      vehicleLabel = [v.year, v.make, v.model, v.trim].filter(Boolean).join(' ');
      document.getElementById('vehicleBanner').innerHTML = `<strong style="font-size:18px">${vehicleLabel}</strong>${v.bodyClass?(' · '+v.bodyClass):''}${miles?(' · '+miles.toLocaleString()+' mi'):''}`;
      valuation = await fetch(`/api/value/${vin}?mileage=${miles}&year=${v.year||''}`).then(r=>r.json());
      setText('vRetail', fmt(valuation.retail)); setText('vWholesale', fmt(valuation.wholesale));
      document.getElementById('valRaw').textContent = JSON.stringify(valuation,null,2);
      historyData = await fetch(`/api/history/${vin}`).then(r=>r.json());
      document.getElementById('histBadges').textContent = `Accidents ${historyData.accidents} • Owners ${historyData.owners} • Records ${historyData.serviceRecords}`;
      document.getElementById('histRaw').textContent = JSON.stringify(historyData,null,2);
      maintData = await fetch(`/api/maintenance/${vin}`).then(r=>r.json());
      document.getElementById('intervals').innerHTML = Object.entries(maintData.intervals||{}).map(([k,v])=>`<li><strong>${k}</strong>: ${v}</li>`).join('');
      showStep(2); refreshOffer();
    }
  }catch(e){ alert('VIN lookup failed'); }
}

async function uploadCarfax(){
  const f = document.getElementById('carfax').files[0]; if (!f) return alert('Pick a PDF first');
  const fd = new FormData(); fd.append('file', f);
  const res = await fetch('/api/carfax/upload',{ method:'POST', body: fd }).then(r=>r.json());
  if (!res || !res.ok) { alert('Upload failed'); return; }
  carfaxUrl = res.url; carfaxSummary = res.summary; carfaxText = res.text || '';
  document.getElementById('carfaxUrl').innerHTML = `Uploaded: <a href="${carfaxUrl}" target="_blank">${carfaxUrl}</a>`;
  document.getElementById('carfaxBox').innerHTML = carfaxSummary && !carfaxSummary.note
      ? Object.entries(carfaxSummary).map(([k,v])=>`<div class="stat"><span><strong>${k}</strong></span><span>${Array.isArray(v)?v.join(', '):v}</span></div>`).join('')
      : '<span class="muted">No text extracted. Try OCR scan.</span>';
  // Auto-advance to Step 3
  showStep(3);
  refreshOffer();
}

async function summarizeText(){
  const raw = document.getElementById('carfaxPaste').value||'';
  if (!raw.trim()) return alert('Paste the text first');
  const res = await fetch('/api/carfax/summarize-text',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: raw })}).then(r=>r.json());
  if (res.ok){ carfaxSummary = res.summary; document.getElementById('carfaxBox').innerHTML = Object.entries(carfaxSummary).map(([k,v])=>`<div class="stat"><span><strong>${k}</strong></span><span>${Array.isArray(v)?v.join(', '):v}</span></div>`).join(''); refreshOffer(); showStep(3); }
}

// OCR
async function ocrCarfaxFromFile(){
  const f = document.getElementById('carfax').files[0];
  if (!f) { alert('Pick a PDF first'); return; }
  const ab = await f.arrayBuffer();
  return ocrCarfaxFromArrayBuffer(ab);
}
async function ocrCarfaxFromArrayBuffer(arrayBuffer){
  if (!window.pdfjsLib || !window.Tesseract){ alert('OCR libraries not loaded'); return; }
  try{
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    const maxPages = Math.min(pdf.numPages, 10);
    for (let p=1; p<=maxPages; p++){
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({ scale: 1.6 });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({ canvasContext: ctx, viewport }).promise;
      const { data } = await Tesseract.recognize(canvas, 'eng');
      fullText += '\\n\\n' + (data && data.text ? data.text : '');
    }
    if (fullText.trim().length < 30){ alert('OCR found little text. Try higher quality.'); return; }
    carfaxText = fullText;
    const res = await fetch('/api/carfax/summarize-text', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rawText: fullText }) }).then(r=>r.json());
    if (res && res.ok){
      carfaxSummary = res.summary;
      document.getElementById('carfaxBox').innerHTML = Object.entries(carfaxSummary).map(([k,v])=>`<div class="stat"><span><strong>${k}</strong></span><span>${Array.isArray(v)?v.join(', '):v}</span></div>`).join('');
      await applyMaintenance();
      showStep(3);
      refreshOffer();
    } else { alert('OCR summarize failed'); }
  }catch(err){ console.error(err); alert('OCR failed: '+(err?.message||err)); }
}

// Maintenance & Recon
async function applyMaintenance(){
  const year = decoded.year || 0;
  const mileage = Number(document.getElementById('miles').value||0);
  const body = { summary: carfaxSummary||{}, text: carfaxText||'', mileage, year };
  const res = await fetch('/api/infer/maintenance',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
  if (res && res.ok){
    const seen = new Set(maintItems.map(x=>x.key||x.label));
    res.items.forEach(it=>{ const k=it.key||it.label; if(!seen.has(k)){ seen.add(k); maintItems.push(it); } });
    renderMaint(); refreshOffer();
  }
}

function renderMaint(){
  const tbody=document.getElementById('maintRows');
  if (!maintItems.length){ tbody.innerHTML='<tr><td class="muted" colspan="3">No items yet.</td></tr>'; setText('maintTotal', fmt(0)); return; }
  tbody.innerHTML = maintItems.map(it=>`<tr><td>${it.label}</td><td style="text-align:right">${fmt(it.amount)}</td><td class="muted">${Array.isArray(it.rationale)?it.rationale.join(' • '):(it.rationale||'')}</td></tr>`).join('');
  setText('maintTotal', fmt(maintItems.reduce((s,it)=>s+Number(it.amount||0),0)));
}
function renderRecon(){
  const tbody=document.getElementById('reconRows');
  if (!reconItems.length){ tbody.innerHTML='<tr><td class="muted" colspan="3">No additional costs.</td></tr>'; setText('reconTotal', fmt(0)); return; }
  tbody.innerHTML = reconItems.map((it,i)=>`<tr><td>${it.label}</td><td style="text-align:right">${fmt(it.amount)}</td><td><button class="btn ghost" onclick="removeRecon(${i})">Remove</button></td></tr>`).join('');
  setText('reconTotal', fmt(reconItems.reduce((s,it)=>s+Number(it.amount||0),0)));
}
function quick(label, amount, key){ reconItems.push({ label, amount, key }); renderRecon(); refreshOffer(); }
function addRecon(){
  const label=(document.getElementById('reconLabel').value||'').trim();
  const amt=Number(document.getElementById('reconAmt').value||0);
  if (!label || !amt) return;
  reconItems.push({ label, amount: amt, key: label.toLowerCase().replace(/[^a-z0-9]+/g,'_') });
  document.getElementById('reconLabel').value=''; document.getElementById('reconAmt').value='';
  renderRecon(); refreshOffer();
}
function removeRecon(i){ reconItems.splice(i,1); renderRecon(); refreshOffer(); }

async function getEvidence(){
  const vin=document.getElementById('vin').value.trim();
  const vehicle=document.getElementById('vehicleBanner').innerText.trim();
  const res=await fetch('/api/evidence/score',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ vin, vehicle })}).then(r=>r.json());
  if (!res || !res.ok) { alert('Evidence fetch failed'); return; }
  evidence = res;
  document.getElementById('riskBadge').textContent = `Recalls ${res.counts.recalls} • Complaints ${res.counts.complaints} • TSBs ${res.counts.tsbs}`;
  document.getElementById('riskList').innerHTML = (res.topRisks||[]).map(r=>`<li><strong>${r.label}</strong> — score ${r.score} <span class="muted">(${r.rationale})</span></li>`).join('') || '<li class="muted">No notable risks.</li>';
  refreshOffer();
}
function applyRisksToRecon(){
  if (!evidence) return alert('Get evidence first');
  const labels = new Set(reconItems.map(x=>x.key||x.label).concat(maintItems.map(x=>x.key||x.label)));
  let added = 0;
  const map = {
    'Engine / Oil consumption': [{label:'Oil change', amount:60, key:'oil_change'},{label:'Engine air filter', amount:45, key:'engine_air_filter'}],
    'Transmission': [{label:'Transmission service', amount:250, key:'transmission_service'}],
    'Electrical': [{label:'Battery', amount:180, key:'battery'}],
    'Brakes': [{label:'Brakes (pads/rotors est.)', amount:450, key:'brakes'}],
    'HVAC / A/C': [{label:'A/C service', amount:150, key:'ac_service'}]
  };
  (evidence.topRisks||[]).forEach(r=>{
    (map[r.label]||[]).forEach(it=>{ if(!labels.has(it.key)){ reconItems.push(it); labels.add(it.key); added++; } });
  });
  renderRecon(); refreshOffer();
  if (!added) alert('No new recon items (already applied).');
}

// Offer refresh
async function refreshOffer(){
  const payload = { valuation, maintenanceItems: maintItems, reconItems, risks: evidence? (evidence.topRisks||[]) : [] };
  payload.baseWholesale = valuation?.wholesale ?? null;
  const res = await fetch('/api/offer/calc',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(r=>r.json());
  if (!res || !res.ok) return;
  calc = res.numbers;
  maintItems = res.items.maintenance; reconItems = res.items.recon;
  renderMaint(); renderRecon();
  setText('sRetail', fmt(calc.retailBase)); setText('sWhole', fmt(calc.wholesaleBase)); setText('sMaint', '-'+fmt(calc.maintDeduction)); setText('sRecon', fmt(calc.reconTotal)); setText('sRisk', fmt(calc.riskReserve)); setText('sMax', fmt(calc.targetMaxBuy));
  setText('oRetail', fmt(calc.retailBase)); setText('oWhole', fmt(calc.wholesaleBase)); setText('oMaint', '-'+fmt(calc.maintDeduction)); setText('oAdj', fmt(calc.adjWholesale)); setText('oRecon', fmt(calc.reconTotal)); setText('oRisk', fmt(calc.riskReserve)); setText('oHold', fmt((calc.holding||0)+(calc.fees||0))); setText('oMax', fmt(calc.targetMaxBuy));
  document.getElementById('proofCarfax').textContent = JSON.stringify(carfaxSummary||{},null,2);
  document.getElementById('proofEvidence').textContent = JSON.stringify(evidence||{},null,2);
}

// Settings modal
function openSettings(){ loadSettings(); document.getElementById('settingsModal').style.display='flex'; }
function closeSettings(){ document.getElementById('settingsModal').style.display='none'; }
async function loadSettings(){
  const res = await fetch('/api/settings').then(r=>r.json());
  const s = res.settings || {};
  document.getElementById('sLabor').value = s.laborRate||0;
  document.getElementById('sParts').value = s.partsMultiplier||1;
  document.getElementById('sProfit').value = s.desiredProfit||0;
  document.getElementById('sDays').value = s.daysToTurn||0;
  document.getElementById('sApr').value = s.floorplanAPR||0;
  document.getElementById('sTrans').value = s.avgTransport||0;
  document.getElementById('sMkt').value = s.marketingFees||0;
  document.getElementById('sWar').value = s.warrantyReserve||0;
  document.getElementById('sCap').value = s.riskReserveCapPct||0.15;
  const grid = document.getElementById('riskWeightsGrid');
  grid.innerHTML='';
  Object.entries(s.riskWeights||{}).forEach(([k,v])=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML = `<label>${k}</label><input data-key="${k}" value="${v}" type="number" step="1">`;
    grid.appendChild(div);
  });
}
async function saveSettings(){
  const payload = {
    laborRate: Number(document.getElementById('sLabor').value||0),
    partsMultiplier: Number(document.getElementById('sParts').value||1),
    desiredProfit: Number(document.getElementById('sProfit').value||0),
    daysToTurn: Number(document.getElementById('sDays').value||0),
    floorplanAPR: Number(document.getElementById('sApr').value||0),
    avgTransport: Number(document.getElementById('sTrans').value||0),
    marketingFees: Number(document.getElementById('sMkt').value||0),
    warrantyReserve: Number(document.getElementById('sWar').value||0),
    riskReserveCapPct: Number(document.getElementById('sCap').value||0.15),
    riskWeights: {}
  };
  document.querySelectorAll('#riskWeightsGrid input').forEach(inp=>{
    payload.riskWeights[inp.getAttribute('data-key')] = Number(inp.value||0);
  });
  const res = await fetch('/api/settings',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) }).then(r=>r.json());
  if (res && res.ok) { closeSettings(); refreshOffer(); }
}

// eBay comps UI
function getCompQuery(){ return { year: decoded.year||'', make: decoded.make||'', model: decoded.model||'', trim: decoded.trim||'', zip: document.getElementById('compZip').value.trim(), radius: document.getElementById('compRadius').value }; }
async function fetchSold(){
  const q=getCompQuery(); const qs=new URLSearchParams(q).toString();
  const res=await fetch('/api/comps/ebay/sold?'+qs).then(r=>r.json());
  if(!res||!res.ok){ alert('SOLD comps fetch failed (set EBAY_APP_ID env var)'); return; }
  const s=res.stats; setText('soldStats', s.count? `n=${s.count} • p25 ${fmt(s.p25)} • median ${fmt(s.median)} • p75 ${fmt(s.p75)}` : 'No results');
  document.getElementById('soldList').innerHTML=(res.items||[]).slice(0,30).map(it=>`<li><a href="${it.url}" target="_blank">${it.title}</a> — ${fmt(it.price)}</li>`).join('');
}
async function fetchActive(){
  const q=getCompQuery(); const qs=new URLSearchParams(q).toString();
  const res=await fetch('/api/comps/ebay/active?'+qs).then(r=>r.json());
  if(!res||!res.ok){ alert('ACTIVE comps fetch failed (set EBAY_APP_ID env var)'); return; }
  const s=res.stats; setText('activeStats', s.count? `n=${s.count} • p25 ${fmt(s.p25)} • median ${fmt(s.median)} • p75 ${fmt(s.p75)}` : 'No results');
  document.getElementById('activeList').innerHTML=(res.items||[]).slice(0,30).map(it=>`<li><a href="${it.url}" target="_blank">${it.title}</a> — ${fmt(it.price)}</li>`).join('');
}
function useSoldMedian(){
  const txt=document.getElementById('soldStats').textContent||'';
  const m = txt.match(/median \$([0-9,]+)/i);
  if(!m){ alert('Fetch SOLD comps first'); return; }
  const val = Number(m[1].replace(/,/g,''));
  if(!valuation) valuation={ retail: val, wholesale: Math.round(val*0.86) };
  valuation.retail = val;
  setText('vRetail', fmt(valuation.retail));
  refreshOffer();
}
</script>
</body>
</html>
