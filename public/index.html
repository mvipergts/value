<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Car Value, History & Maintenance Tool</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 960px; margin: 0 auto; padding: 20px; }
    input, button, textarea { padding: 8px; margin: 6px 0; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 8px; margin: 12px 0; }
    label { font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 12px; }
  </style>
</head>
<body>
  <h1>Car Value, History & Maintenance Tool</h1>

  <div class="card">
    <label>VIN</label>
    <div class="row">
      <input id="vin" placeholder="e.g., 1G1ZE5ST0GF253821" style="flex:1;"/>
      <button onclick="lookup()">Lookup</button>
    </div>
    <div id="results" class="grid"></div>
  </div>

  <div class="card">
    <h3>Upload Carfax PDF</h3>
    <input type="file" id="carfax" accept="application/pdf"/>
    <button onclick="uploadCarfax()">Upload</button>
    <div id="carfaxUrl"></div>
  </div>

  <div class="card">
    <h3>Appraisal Details</h3>
    <textarea id="vehicle" placeholder="Year Make Model Trim" rows="1" style="width:100%"></textarea>
    <textarea id="notes" placeholder="Notes" rows="3" style="width:100%"></textarea>
    <textarea id="recon" placeholder="Reconditioning items (comma separated)" rows="2" style="width:100%"></textarea>
    <button onclick="saveAppraisal()">Save Appraisal</button>
    <button onclick="makePdf()">Generate PDF</button>
  </div>

  <p><a href="/appraisals.html">View recent appraisals</a></p>

  <script>
    let valuation, history, maintenance, carfaxUrl;

    function box(title, json) {
      return `<div><h4>${title}</h4><pre>${JSON.stringify(json, null, 2)}</pre></div>`;
    }

    async function lookup() {
      const vin = document.getElementById('vin').value.trim();
      if (!vin) return alert('Enter a VIN');
      const v = await fetch(`/api/value/${vin}`).then(r=>r.json());
      const h = await fetch(`/api/history/${vin}`).then(r=>r.json());
      const m = await fetch(`/api/maintenance/${vin}`).then(r=>r.json());
      valuation = v; history = h; maintenance = m;
      document.getElementById('results').innerHTML = box('Value', v)+box('History', h)+box('Maintenance', m);
    }

    async function uploadCarfax() {
      const file = document.getElementById('carfax').files[0];
      if (!file) return alert('Choose a PDF first');
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/api/carfax/upload', { method: 'POST', body: fd }).then(r=>r.json());
      if (res.url) {
        carfaxUrl = res.url;
        document.getElementById('carfaxUrl').innerHTML = `<a href="${res.url}" target="_blank">Uploaded: ${res.url}</a>`;
      } else {
        alert('Upload failed');
      }
    }

    async function saveAppraisal() {
      const vin = document.getElementById('vin').value.trim();
      if (!vin) return alert('Enter a VIN');
      const vehicle = document.getElementById('vehicle').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const reconItems = document.getElementById('recon').value.split(',').map(s=>s.trim()).filter(Boolean);
      const body = { vin, vehicle, valuation, history, maintenance, notes, reconItems, carfaxUrl };
      const res = await fetch('/api/appraisals', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) }).then(r=>r.json());
      alert(res.ok ? 'Saved!' : 'Failed to save');
    }

    async function makePdf() {
      const vin = document.getElementById('vin').value.trim();
      if (!vin) return alert('Enter a VIN');
      const vehicle = document.getElementById('vehicle').value.trim();
      const notes = document.getElementById('notes').value.trim();
      const reconItems = document.getElementById('recon').value.split(',').map(s=>s.trim()).filter(Boolean);
      const res = await fetch('/api/report', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ vin, vehicle, valuation, history, maintenance, notes, reconItems, carfaxUrl, dealer: { name: 'OpenSource Autos', address: '4801 Lamar Ave, Mission, KS 66202', phone: '(816) 807-8577', site: 'opensourceautos.com' } })
      }).then(r=>r.json());
      if (res.url) window.open(res.url, '_blank'); else alert('Failed to generate PDF');
    }
  </script>
</body>
</html>